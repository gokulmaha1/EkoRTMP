<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- RESET & VARIABLES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Palette */
            --header-bg: #b90909;
            /* Deep Red */
            --footer-bg: #ffffff;
            --text-black: #000000;
            --text-white: #ffffff;
            --accent-gold: #f1c40f;

            /* Dimensions */
            --header-height: 90px;
            --ticker-height: 70px;
        }

        body {
            background-color: #000;
            /* Chroma Key or Video BG */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            width: 1280px;
            height: 720px;
        }

        /* --- MAIN LAYOUT (GRID) --- */
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
            position: relative;
        }

        /* --- HEADER SECTION --- */
        /* --- VISUAL POLISH (PREMIUM TV LOOK) --- */
        :root {
            /* Simplified Gradients for Performance */
            --header-gradient: #b90909;
            /* Solid color is faster */
            /* --gloss-overlay: linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.1) 100%); */
            /* --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.5); */
            /* Removed shadow */
        }

        /* --- HEADER SECTION --- */
        .top-header {
            grid-row: 1;
            background: var(--header-gradient);
            /* TABLE LAYOUT: Maximum Compatibility & Stability */
            display: table;
            width: 100%;
            table-layout: fixed;
            padding: 0 10px;
            border-bottom: 3px solid #ffcc00;
            /* Gold Accent Bottom */
            z-index: 100;
            /* box-shadow: var(--shadow-soft); */
            height: var(--header-height);
            position: relative;
        }

        /* Gloss Shine Effect (Pseudo-element for safety) 
        .top-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
            z-index: 0;
        }
        */

        /* Header Columns */
        .header-left {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: left;
            height: 100%;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .header-center {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            height: 100%;
            overflow: hidden;
            padding: 0 20px;
            position: relative;
            z-index: 2;
            width: 80%;
        }

        .header-right {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: right;
            height: 100%;
            position: relative;
            z-index: 2;
            padding-right: 15px;
        }

        /* Header Elements */
        .location-tag {
            background: #f0f0f0;
            /* Simplified gradient */
            color: #b90909;
            padding: 6px 15px;
            border-radius: 4px;
            /* Condensed Font */
            font-weight: 700;
            font-size: 20px;
            text-transform: uppercase;
            /* box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); */
            display: inline-flex;
            /* Fix flex alignment inside table cell */
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
        }

        .breaking-text {
            color: white !important;
            /* Better Tamil Font support */
            font-size: 32px;
            /* Large TV Size */
            font-weight: 700;
            white-space: nowrap;
            /* text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5); */
            /* Simplified Shadow */
            text-shadow: 1px 1px 0 #000;
            /* Ensure Visibility */
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            text-align: center;
            /* Center multi-line text */
            line-height: 1.2;
        }

        .logo-img {
            height: 94px;
            width: auto;
            object-fit: contain;
            /* filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4)); */
            display: inline-block !important;
        }

        /* --- MAIN CONTENT (Video + L-Bar) --- */
        .main-content {
            grid-row: 2;
            position: relative;
            background-color: transparent;
            display: flex;
            overflow: hidden;
        }

        .video-wrapper {
            flex-grow: 1;
            position: relative;
        }

        /* L-Bar (Side Panel) */
        .l-bar {
            width: 0;
            /* Hidden by default */
            background: #000;
            transition: width 0.5s ease;
            display: none;
        }

        /* Media Elements */
        #videoPlayer,
        #imagePlayer,
        #webview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            border: none;
        }

        /* --- FOOTER SECTION --- */
        .bottom-footer {
            grid-row: 3;
            background-color: var(--footer-bg);
            /* TABLE LAYOUT: For Stability */
            display: table;
            width: 100%;
            table-layout: fixed;
            border-top: 4px solid #cc0000;
            z-index: 100;
            height: var(--ticker-height);
            /* box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2); */
        }

        .ticker-label {
            display: table-cell;
            width: 180px;
            /* Fixed Width */
            vertical-align: middle;
            background: var(--header-gradient);
            /* Match Header */
            color: white;
            font-size: 22px;
            font-weight: 700;
            padding: 0 25px;
            height: 100%;
            z-index: 10;
            text-transform: uppercase;
            /* box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); */
            /* Separation Shadow */
            position: relative;
        }

        /* Ticker Triangle Arrow */
        .ticker-label::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 0;
            bottom: 0;
            width: 10px;
            background: inherit;
            clip-path: polygon(0 0, 100% 50%, 0 100%);
            z-index: 12;
        }

        .ticker-container {
            display: table-cell;
            vertical-align: middle;
            background: white;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .ticker-content {
            display: block;
            width: 100%;
            padding-top: 5px;
            /* Center text vertically */
        }

        .ticker-item {
            font-size: 28px;
            font-weight: 600;
            color: #000;
            margin-right: 80px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .footer-right {
            display: table-cell;
            width: 240px;
            /* Slightly wider */
            vertical-align: middle;
            background: #f0f0f0;
            /* Simplified gradient */
            height: 100%;
            border-left: 2px solid #ddd;
            padding: 0 15px;
            z-index: 20;
            /* box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1); */
        }

        .live-badge {
            background: #d60000;
            color: white;
            font-weight: 700;
            padding: 7px 10px;
            border-radius: 25px;
            font-size: 14px;
            display: inline-flex !important;
            align-items: stretch;
            gap: 6px;
            /* box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); */
            float: right;
            display: inline-block;
            /* margin-top: 4px; */
            flex-direction: row;

        }

        .datetime {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
        }

        .time-display {
            font-family: 'Oswald', sans-serif;
            font-size: 25px;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1;
            margin-bottom: 4px;
            margin-right: 3px;
        }

        .date-display {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Blink Animation */
        .blink-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
            float: left;
            margin-top: 9px;
            margin-left: 2px;
            margin-right: 5px;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        /* --- ANIMATIONS --- */
        @keyframes slideOutDown {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        @keyframes slideInDown {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-out {
            animation: slideOutDown 0.5s forwards;
        }

        .animate-in {
            animation: slideInDown 0.5s forwards;
        }

        /* --- SMOOTH TICKER --- */
        .ticker-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }

        .ticker-track {
            display: flex;
            white-space: nowrap;
            will-change: transform;
            /* Animation applied via JS for dynamic speed */
        }

        @keyframes scroll-linear {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        /* --- NEWS PRESENTATION (SPLIT VIEW) --- */
        .news-presentation {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            background: #e0e0e0;
            /* Simplified gradient */
            z-index: 50;
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* --- LAYOUT MODES --- */
        .news-presentation.no-media .np-media {
            display: none !important;
        }

        .news-presentation.no-media .np-content {
            flex: 1;
            /* Take full width */
            padding: 80px;
            /* More padding for cleaner look */
            align-items: center;
            /* Center text */
            text-align: center;
        }

        .np-media {
            flex: 6;
            /* 60% width */
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-right: 4px solid #cc0000;
        }

        .np-media img,
        .np-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .placeholder-icon {
            font-size: 80px;
            color: #555;
        }

        .np-content {
            flex: 4;
            /* 40% width */
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: white;
            /* box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); */
        }

        /* --- ANIMATIONS: Text & Media --- */
        /* Ken Burns Removed for Performance */

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .ken-burns-active {
            /* animation: kenBurns 15s linear forwards; */
            /* Ken Burns Disabled */
        }

        @keyframes newsFadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .anim-title {
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.2s forwards;
        }

        .anim-desc {
            opacity: 0;
            /* Tamil TV Style: Sharp wipe from left with slight slide */
            /* Simplified Fade In */
            animation: newsFadeIn 0.5s ease-out 0.2s forwards;
            background: rgba(0, 0, 0, 0.03);
            /* Subtle backdrop */
            padding: 15px;
            border-left: 4px solid #b90909;
            /* Red accent line */
            border-radius: 0 8px 8px 0;
        }

        .anim-meta {
            opacity: 0;
            animation: fadeIn 1s ease-out 0.8s forwards;
        }

        /* --- TRANSITIONS --- */
        .page-exit {
            animation: slideOutLeft 0.5s ease-in forwards;
        }

        .page-enter {
            animation: slideInRight 0.5s ease-out forwards;
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        .np-tag {
            background: #b90909;
            color: white;
            align-self: flex-start;
            padding: 5px 15px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 18px;
            margin-bottom: 20px;
            border-radius: 4px;
            opacity: 0;
            /* Animation handled by JS adding classes */
        }

        .anim-tag-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .np-content h1 {
            font-size: 36px;
            line-height: 1.2;
            margin-bottom: 20px;
            color: #2c3e50;
            font-family: 'Baloo Thambi 2', sans-serif;
            /* Animation handled by class .anim-title */
        }

        .np-content p {
            font-size: 22px;
            color: #555;
            line-height: 1.5;
            margin-bottom: 30px;
            font-family: 'Roboto', sans-serif;
            /* Animation handled by class .anim-desc */
        }

        .np-meta {
            margin-top: auto;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            color: #888;
            font-size: 16px;
            font-weight: 600;
            /* Animation handled by class .anim-meta */
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- ROW 1: HEADER -->
        <div class="top-header">
            <!-- Left: Location -->
            <div class="header-left">
                <div class="location-tag">
                    <!-- <i class="fas fa-map-marker-alt"></i> -->
                    <span id="locationText">அண்மை செய்திகள்</span>
                </div>
            </div>

            <!-- Center: Headline -->
            <div class="header-center">
                <div id="topHeadline" class="breaking-text">
                    தமிழ் செய்திகள் 24x7
                </div>
            </div>

            <!-- Right: Logo -->
            <div class="header-right">
                <!-- Direct Path with default fallback -->
                <img id="headerLogo" src="media/logo.gif" class="logo-img" alt="Logo">
            </div>
        </div>

        <!-- ROW 2: MAIN CONTENT -->
        <div class="main-content">
            <div class="video-wrapper">
                <iframe id="webview" src=""></iframe>
                <video id="videoPlayer" muted playsinline></video>
                <img id="imagePlayer" src="">
            </div>

            <!-- NEWS PRESENTATION (Split View) -->
            <div id="newsPresentation" class="news-presentation" style="display: none;">
                <div class="np-media">
                    <!-- Media Content (Image or Video) -->
                    <img id="npImage" src="" style="display: none;">
                    <video id="npVideo" muted playsinline loop style="display: none;"></video>
                    <div id="npPlaceholder" class="placeholder-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                </div>
                <div class="np-content">
                    <!-- <div class="np-tag" id="npCategory">TAMIL NADU</div> -->
                    <h1 id="npTitle">News Headline Goes Here</h1>
                    <!-- <p id="npDescription"></p> -->
                    <!-- <div class="np-meta">
                        <span id="npSource"><i class="fas fa-link"></i> Source Name</span>
                    </div> -->
                </div>
            </div>

            <!-- Optional L-Bar -->
            <div id="lBar" class="l-bar" style="display: none;">
                <div id="lBarContent" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <!-- ROW 3: FOOTER -->
        <div class="bottom-footer">
            <div class="ticker-label">NEWS UPDATES</div>

            <div class="ticker-container">
                <div class="ticker-container">
                    <!-- Smooth CSS Ticker -->
                    <div class="ticker-wrapper">
                        <div id="tickerTrack" class="ticker-track"></div>
                    </div>
                </div>
            </div>

            <div class="footer-right">
                <div class="live-badge">நேரலை <div class="blink-dot"></div>
                </div>
                <div class="datetime">
                    <div id="clock" class="time-display">12:00 PM</div>
                    <div id="dateDisplay" class="date-display">01/01/2026</div>
                </div>
                <!-- Optional Footer Logo
                <img src="/media/logo.gif" class="logo-img" style="height: 40px; margin-left: 5px;">
                -->
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
        const DEFAULT_LOGO = "/media/logo.gif";
        const API_BASE = window.location.origin + '/api';
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // STATE
        let newsItems = [];
        let headlineIndex = 0;
        let headlineInterval = null;

        // --- CLOCK ---
        function updateTime() {
            const now = new Date();
            // Force IST Timezone
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            });
            const dateStr = now.toLocaleDateString('en-GB', {
                timeZone: 'Asia/Kolkata'
            }); // DD/MM/YYYY

            document.getElementById('clock').innerText = timeStr;
            document.getElementById('dateDisplay').innerText = dateStr;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- LOG DATA & CONFIG ---
        async function fetchConfig() {
            try {
                const res = await fetch(API_BASE + '/config');
                const conf = await res.json();
                applyConfig(conf);
            } catch (e) {
                console.error("Config Fetch Error:", e);
                // Fallback already in HTML
            }
        }

        function applyConfig(conf) {
            const root = document.documentElement;

            // Colors
            if (conf.brand_color_primary) root.style.setProperty('--header-bg', conf.brand_color_primary);
            if (conf.brand_color_dark) document.body.style.backgroundColor = conf.brand_color_dark; // Debug bg

            // Logo
            const logoUrl = conf.logo_url || DEFAULT_LOGO;
            const logoEl = document.getElementById('headerLogo');
            if (logoEl) {
                logoEl.src = logoUrl;
                logoEl.style.display = 'block'; // Force show
            }

            // Text Labels
            if (conf.location_label) document.getElementById('locationText').innerText = conf.location_label;

            // L-Bar Logic
            const lBar = document.getElementById('lBar');
            const wrapper = document.querySelector('.main-content');

            if (conf.layout_mode === 'L_BAR') {
                const w = conf.lbar_width || 25;
                lBar.style.display = 'block';
                lBar.style.width = w + '%';
                lBar.style.backgroundColor = conf.lbar_bg_color || '#000';

                // Position
                wrapper.style.flexDirection = (conf.lbar_position === 'LEFT') ? 'row-reverse' : 'row';

                // Content
                const contentDiv = document.getElementById('lBarContent');
                if (conf.lbar_content_type === 'IMAGE' && conf.lbar_content_data) {
                    contentDiv.innerHTML = `<img src="${conf.lbar_content_data}" style="width:100%;height:100%;object-fit:cover;">`;
                } else if (conf.lbar_content_type === 'URL') {
                    contentDiv.innerHTML = `<iframe src="${conf.lbar_content_data}" style="width:100%;height:100%;border:none;"></iframe>`;
                }
            } else {
                lBar.style.width = '0';
                setTimeout(() => lBar.style.display = 'none', 500);
            }
        }

        // --- NEWS HANDLING ---
        async function fetchNews() {
            try {
                const res = await fetch(API_BASE + '/news');
                newsItems = await res.json();
                console.log(`Loaded ${newsItems.length} news items.`);
                updateTicker();
                if (!headlineInterval) startHeadlines();
            } catch (e) { console.error("News Fetch Error:", e); }
        }

        let lastTickerHash = "";

        function updateTicker() {
            const active = newsItems.filter(i => i.is_active);
            const track = document.getElementById('tickerTrack');

            if (active.length === 0) {
                track.innerHTML = "";
                return;
            }

            // Create single pass string
            const singlePassHtml = active.map(i =>
                `<span class="ticker-item"><i class="fas fa-circle" style="font-size:15px; color:#b90909;"></i> ${i.title_tamil}</span>`
            ).join('');

            // CHECK IF CONTENT CHANGED
            // If the content is identical to what we last rendered, DO NOT reset the animation
            if (singlePassHtml === lastTickerHash) {
                // Determine if we need to restart animation if it stopped? 
                // Usually no, CSS infinite loop handles it.
                // However, if the duration needs to change due to container resize?
                // For now, assume fixed container size.
                return;
            }

            lastTickerHash = singlePassHtml;

            // DUPLICATE CONTENT for seamless loop (A + A)
            // When we scroll to -50% (end of first A), we are visually at the start of second A,
            // which is identical to start of first A. Resetting to 0% is invisible.
            track.innerHTML = singlePassHtml + singlePassHtml;

            // Calculate Speed (Pixels Per Second)
            // We want constant speed regardless of content width
            const PIXELS_PER_SECOND = 150; // Adjust for speed

            // Measure clear width (approximate or wait for render)
            // Ideally we wait, but estimation is safe here for updates
            // We can use a short timeout to let DOM render width
            setTimeout(() => {
                const totalWidth = track.scrollWidth;
                const halfWidth = totalWidth / 2; // The width of one set of items

                // If content is too short to scroll (less than screen width), maybe just center it or duplicate more?
                // For now, standard behavior.

                const duration = halfWidth / PIXELS_PER_SECOND;

                track.style.animation = 'none';
                track.offsetHeight; /* trigger reflow */
                track.style.animation = `scroll-linear ${duration}s linear infinite`;
            }, 50);
        }



        // --- WEBSOCKET ---
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("WS Connected");
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type.includes('NEWS')) fetchNews();
            if (msg.type === 'CONFIG_UPDATED') applyConfig(msg.payload);
            if (msg.type === 'OVERLAY_UPDATED') updateMainScreen(msg.payload);
            if (msg.type === 'SHOW_NEWS_MAIN') showNewsLayout(msg.payload);
        };

        // --- HELPER: Detect Media Type ---
        function getMediaType(url) {
            if (!url) return 'NONE';
            // Remove query params for extension check
            const cleanUrl = url.split('?')[0].toLowerCase();

            if (cleanUrl.match(/\.(mp4|webm|ogg|mov)$/)) return 'VIDEO';
            if (cleanUrl.match(/\.(jpeg|jpg|gif|png|webp|bmp|svg)$/)) return 'IMAGE';
            return 'WEB';
        }

        // --- MAIN SCREEN LOGIC ---
        // Persistence
        let lastMainScreenData = { webview_url: "" };

        function updateMainScreen(data) {
            // If this is NOT an Ad, save it as the "Default" state
            if (data.type !== 'AD') {
                lastMainScreenData = { ...data };
            }

            // Hide News Layout if active (unless we are just updating background behind it?)
            // If ad, force hide. If config update, maybe not? 
            // generally updateMainScreen implies "Show this now".

            if (data.type === 'AD') {
                document.getElementById('newsPresentation').style.display = 'none';
            }

            renderMainScreen(data);
        }

        function renderMainScreen(data) {
            const webview = document.getElementById('webview');
            const video = document.getElementById('videoPlayer');
            const image = document.getElementById('imagePlayer');

            // Reset
            webview.style.display = 'none'; webview.src = "";
            video.style.display = 'none'; video.pause();
            image.style.display = 'none'; image.src = "";

            const url = data.webview_url;
            if (!url) return;

            const type = getMediaType(url);

            if (type === 'VIDEO') {
                video.src = url;
                video.style.display = 'block';
                video.play().catch(e => console.error("Autoplay failed", e));
            } else if (type === 'IMAGE') {
                image.src = url;
                image.style.display = 'block';
            } else {
                // Assume Web/Iframe
                webview.src = url;
                webview.style.display = 'block';
            }
        }

        function restoreBackground() {
            // Called when News Layout hides
            renderMainScreen(lastMainScreenData);
        }

        // --- TRANSITION LOGIC ---
        let isTransitioning = false;

        async function showNewsLayout(item) {
            // Check if already showing this item to avoid redundant anims? 
            // Actually, for loop, we might want to re-show.

            const container = document.getElementById('newsPresentation');

            // If already visible, transition OUT first
            if (container.style.display === 'flex' && !isTransitioning) {
                isTransitioning = true;
                container.classList.add('page-exit');

                // Wait for animation
                await new Promise(r => setTimeout(r, 500));

                container.classList.remove('page-exit');
                // Reset scroll/state if needed
                isTransitioning = false;
            }

            // Hide standard players? 
            // If we hide them, we save resources, but we might have a black gap during transition.
            // Since newsPresentation is z-index 50 and transparent? No, it has background.
            // Let's NOT hide them immediately, but maybe pause video if it's heavy?
            // For smooth transition, keep them.

            // document.getElementById('webview').style.display = 'none';
            // document.getElementById('videoPlayer').style.display = 'none';
            // document.getElementById('imagePlayer').style.display = 'none';

            // Populate Data
            // Populate Data
            const cat = document.getElementById('npCategory');
            const tit = document.getElementById('npTitle');
            const desc = document.getElementById('npDescription');
            const meta = document.getElementById('npSource');

            if (cat) cat.innerText = item.category || 'NEWS';
            if (tit) tit.innerText = item.title;
            if (desc) desc.innerText = item.description || item.title; // Fallback
            if (meta) meta.innerHTML = `<i class="fas fa-link"></i> ${item.source}`;

            // --- RESET TEXT ANIMATIONS ---
            if (cat) cat.classList.remove('anim-tag-in');
            if (tit) tit.classList.remove('anim-title');
            if (desc) desc.classList.remove('anim-desc');
            if (meta) meta.classList.remove('anim-meta');

            if (tit) void tit.offsetWidth; // Reflow

            if (cat) cat.classList.add('anim-tag-in');
            if (tit) tit.classList.add('anim-title');
            if (desc) desc.classList.add('anim-desc');
            if (meta) meta.classList.add('anim-meta');

            // Handle Media
            const img = document.getElementById('npImage');
            const vid = document.getElementById('npVideo');
            const placeholder = document.getElementById('npPlaceholder');

            img.style.display = 'none';
            vid.style.display = 'none';
            placeholder.style.display = 'none';
            img.classList.remove('ken-burns-active'); // Reset Ken Burns

            // Reset Toggle Class
            container.classList.remove('no-media');

            if (item.media_url && getMediaType(item.media_url) !== 'NONE') {
                const type = getMediaType(item.media_url);

                if (type === 'VIDEO') {
                    vid.src = item.media_url;
                    vid.style.display = 'block';
                    vid.play().catch(e => console.error("News AutoPlay Error:", e));
                } else {
                    img.src = item.media_url;
                    img.style.display = 'block';

                    // Trigger Ken Burns Reflow
                    void img.offsetWidth;
                    img.classList.add('ken-burns-active');
                }
            } else {
                // NO MEDIA -> TEXT ONLY MODE
                container.classList.add('no-media');
            }

            // Show Container with ENTER animation
            container.style.display = 'flex';
            container.classList.remove('page-enter');
            void container.offsetWidth;
            container.classList.add('page-enter');

            // --- TRIGGER BACKEND TTS ---
            if (item.title) {
                fetch(API_BASE + '/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: item.title, lang: 'ta' })
                }).catch(err => console.error("TTS Auto-Trigger Failed:", err));
            }
        }

        // --- ADVERTISEMENT LOGIC ---
        let activeAds = [];

        async function fetchAds() {
            try {
                const res = await fetch(API_BASE + '/ads/active');
                activeAds = await res.json();
                console.log(`Loaded ${activeAds.length} active ads.`);
            } catch (e) { console.error("Ad Fetch Error:", e); }
        }

        function getAdsByType(type) {
            return activeAds.filter(a => a.type === type);
        }

        // --- FULLSCREEN ADS & INTERRUPTIONS ---
        let adIntervalHandle = null;
        const AD_CHECK_INTERVAL = 60000; // Check every minute

        function startAdScheduler() {
            if (adIntervalHandle) clearInterval(adIntervalHandle);

            // Check less frequently to avoid constant interruption, but enough to catch schedule
            adIntervalHandle = setInterval(() => {
                const fsAds = getAdsByType('FULLSCREEN');
                if (fsAds.length > 0 && Math.random() > 0.5) { // 50% chance to play if available, or use strict interval
                    // Pick one
                    const ad = fsAds[Math.floor(Math.random() * fsAds.length)];
                    playFullscreenAd(ad);
                }
            }, 5 * 60 * 1000); // 5 Minutes
        }

        function playFullscreenAd(ad) {
            console.log("Playing Ad:", ad);

            // 1. Stop News Rotation
            if (headlineInterval) clearInterval(headlineInterval);

            // 2. Show Ad
            updateMainScreen({
                webview_url: ad.content,
                type: 'AD'
            });

            // 3. Resume after Duration
            setTimeout(() => {
                // Determine what to do next?
                // Ideally, go back to News Loop
                startHeadlines();
            }, ad.duration * 1000);
        }

        // --- CORE LOOP ---
        function startHeadlines() {
            if (headlineInterval) clearInterval(headlineInterval);
            // Immediate trigger
            rotateHeadline();
            // Loop
            headlineInterval = setInterval(rotateHeadline, 15000); // 15s per item
        }

        function rotateHeadline() {
            // Priority:
            // 1. If Ad is playing, do nothing? (Handled by clearing interval)

            if (newsItems.length === 0) return;



            // Use all active items (Text-only news will use no-media layout)
            let pool = newsItems.filter(i => i.is_active);

            if (pool.length === 0) {
                // No image news available? Hide news presentation to show background stream
                document.getElementById('newsPresentation').style.display = 'none';
                return;
            }

            headlineIndex = (headlineIndex + 1) % pool.length;
            const item = pool[headlineIndex];

            // --- HEADER UPDATE ---
            const el = document.getElementById('topHeadline');
            el.classList.remove('animate-in');
            el.classList.add('animate-out');

            setTimeout(() => {
                const text = item.title_tamil || "";
                el.innerText = text;
                // Sizing text
                if (text.length > 50) {
                    el.style.fontSize = "22px";
                    el.style.whiteSpace = "normal";
                    el.style.lineHeight = "1.3";
                } else {
                    el.style.fontSize = "32px";
                    el.style.whiteSpace = "nowrap";
                    el.style.lineHeight = "1.2";
                }

                // Location - Always show static label
                document.getElementById('locationText').innerText = "அண்மை செய்திகள்";

                el.classList.remove('animate-out');
                el.classList.add('animate-in');
            }, 500);


            const isRecent = (now - itemDate) < MAX_AGE_MS;

            // --- MAIN SCREEN AUTOMATION ---
            // Always show news layout (it handles media/no-media internaly)

            // --- MAIN SCREEN AUTOMATION ---
            // Logic: If media exists, show split view.
            // If NOT, show Text-Only mode (Full width content).

            const displayItem = {
                id: item.id,
                title: item.title_tamil,
                category: item.category,
                media_url: item.media_url,
                source: item.source,
                description: item.title_english || item.title_tamil
            };
            showNewsLayout(displayItem);

        }





        // INIT
        fetchConfig();
        fetchNews();
        fetchAds();

        // Fallback Poll (Disabled/Relaxed)
        // setInterval(fetchNews, 20000);
        // setInterval(fetchAds, 30000); 
        // setInterval(fetchConfig, 10000);

        // Start Scheduler
        setTimeout(startAdScheduler, 5000); // Delay start

    </script>
</body>

</html>