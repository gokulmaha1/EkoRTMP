<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- RESET & VARIABLES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Palette */
            --header-bg: #b90909;
            /* Deep Red */
            --footer-bg: #ffffff;
            --text-black: #000000;
            --text-white: #ffffff;
            --accent-gold: #f1c40f;

            /* Dimensions */
            --header-height: 90px;
            --ticker-height: 70px;
        }

        body {
            background-color: #000;
            /* Chroma Key or Video BG */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            width: 1280px;
            height: 720px;
        }

        /* --- MAIN LAYOUT (GRID) --- */
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
            position: relative;
        }

        /* --- HEADER SECTION --- */
        .top-header {
            grid-row: 1;
            background-color: var(--header-bg);
            display: flex;
            /* Flexbox Layout */
            align-items: center;
            /* Vertical Center */
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Header Columns */
        .header-left {
            flex: 0 0 200px;
            /* Fixed Width */
            display: flex;
            align-items: center;
            height: 100%;
        }

        .header-center {
            flex: 1;
            /* Grow to fill space */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            overflow: hidden;
            /* Prevent spill */
            padding: 0 20px;
        }

        .header-right {
            flex: 0 0 150px;
            /* Fixed Width */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            /* Align Logo Right */
            height: 100%;
        }

        /* Header Elements */
        .location-tag {
            background: white;
            color: #b90909;
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 18px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .breaking-text {
            color: white !important;
            font-size: 34px;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
            /* Ensure Visibility */
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            top: auto !important;
            left: auto !important;
        }

        .logo-img {
            max-height: 70px;
            /* Fit within 90px header */
            max-width: 100%;
            object-fit: contain;
            /* Ensure Visibility */
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* --- MAIN CONTENT (Video + L-Bar) --- */
        .main-content {
            grid-row: 2;
            position: relative;
            background-color: transparent;
            /* Show underlying video if needed */
            display: flex;
            overflow: hidden;
        }

        .video-wrapper {
            flex-grow: 1;
            position: relative;
        }

        /* L-Bar (Side Panel) */
        .l-bar {
            width: 0;
            /* Hidden by default */
            background: #000;
            transition: width 0.5s ease;
            display: none;
        }

        /* Media Elements */
        #videoPlayer,
        #imagePlayer,
        #webview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            border: none;
        }

        /* --- FOOTER SECTION --- */
        .bottom-footer {
            grid-row: 3;
            background-color: var(--footer-bg);
            display: flex;
            align-items: center;
            border-top: 4px solid var(--header-bg);
            z-index: 100;
        }

        .ticker-label {
            flex: 0 0 auto;
            background-color: var(--header-bg);
            color: white;
            font-family: 'Oswald', sans-serif;
            font-size: 20px;
            font-weight: 700;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 10;
        }

        .ticker-container {
            flex: 1;
            /* Fill remaining */
            overflow: hidden;
            background: white;
            height: 100%;
            display: flex;
            align-items: center;
            position: relative;
        }

        .ticker-content {
            display: flex;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            /* Fixed readable speed */
        }

        .ticker-item {
            font-size: 26px;
            font-weight: 700;
            color: black;
            margin-right: 60px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .footer-right {
            flex: 0 0 220px;
            /* Fixed Width for Clock/Live */
            background-color: #f1f2f6;
            height: 100%;
            border-left: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            z-index: 20;
        }

        .live-badge {
            background: #d60000;
            color: white;
            font-family: 'Oswald', sans-serif;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .datetime {
            text-align: right;
            line-height: 1.2;
        }

        .time-display {
            font-family: 'Oswald';
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .date-display {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        .blink-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- ROW 1: HEADER -->
        <div class="top-header">
            <!-- Left: Location -->
            <div class="header-left">
                <div class="location-tag">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">LATEST NEWS</span>
                </div>
            </div>

            <!-- Center: Headline -->
            <div class="header-center">
                <div id="topHeadline" class="breaking-text">
                    Initializing News System...
                </div>
            </div>

            <!-- Right: Logo -->
            <div class="header-right">
                <!-- Direct Path with default fallback -->
                <img id="headerLogo" src="/media/logo.gif" class="logo-img" alt="Logo">
            </div>
        </div>

        <!-- ROW 2: MAIN CONTENT -->
        <div class="main-content">
            <div class="video-wrapper">
                <iframe id="webview" src=""></iframe>
                <video id="videoPlayer" muted playsinline></video>
                <img id="imagePlayer" src="">
            </div>
            <!-- Optional L-Bar -->
            <div id="lBar" class="l-bar">
                <div id="lBarContent" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <!-- ROW 3: FOOTER -->
        <div class="bottom-footer">
            <div class="ticker-label">NEWS UPDATES</div>

            <div class="ticker-container">
                <div id="tickerText" class="ticker-content">
                    <!-- JS will inject items here -->
                    <span class="ticker-item">Waiting for news updates...</span>
                </div>
            </div>

            <div class="footer-right">
                <div class="live-badge">LIVE <div class="blink-dot"></div>
                </div>
                <div class="datetime">
                    <div id="clock" class="time-display">12:00 PM</div>
                    <div id="dateDisplay" class="date-display">01/01/2026</div>
                </div>
                <!-- Optional Footer Logo
                <img src="/media/logo.gif" class="logo-img" style="height: 40px; margin-left: 5px;">
                -->
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
        const DEFAULT_LOGO = "/media/logo.gif";
        const API_BASE = window.location.origin + '/api';
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // STATE
        let newsItems = [];
        let headlineIndex = 0;
        let headlineInterval = null;

        // --- CLOCK ---
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const dateStr = now.toLocaleDateString('en-GB'); // DD/MM/YYYY

            document.getElementById('clock').innerText = timeStr;
            document.getElementById('dateDisplay').innerText = dateStr;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- LOG DATA & CONFIG ---
        async function fetchConfig() {
            try {
                const res = await fetch(API_BASE + '/config');
                const conf = await res.json();
                applyConfig(conf);
            } catch (e) {
                console.error("Config Fetch Error:", e);
                // Fallback already in HTML
            }
        }

        function applyConfig(conf) {
            const root = document.documentElement;

            // Colors
            if (conf.brand_color_primary) root.style.setProperty('--header-bg', conf.brand_color_primary);
            if (conf.brand_color_dark) document.body.style.backgroundColor = conf.brand_color_dark; // Debug bg

            // Logo
            const logoUrl = conf.logo_url || DEFAULT_LOGO;
            const logoEl = document.getElementById('headerLogo');
            if (logoEl) logoEl.src = logoUrl;

            // Text Labels
            if (conf.location_label) document.getElementById('locationText').innerText = conf.location_label;

            // L-Bar Logic
            const lBar = document.getElementById('lBar');
            const wrapper = document.querySelector('.main-content');

            if (conf.layout_mode === 'L_BAR') {
                const w = conf.lbar_width || 25;
                lBar.style.display = 'block';
                lBar.style.width = w + '%';
                lBar.style.backgroundColor = conf.lbar_bg_color || '#000';

                // Position
                wrapper.style.flexDirection = (conf.lbar_position === 'LEFT') ? 'row-reverse' : 'row';

                // Content
                const contentDiv = document.getElementById('lBarContent');
                if (conf.lbar_content_type === 'IMAGE' && conf.lbar_content_data) {
                    contentDiv.innerHTML = `<img src="${conf.lbar_content_data}" style="width:100%;height:100%;object-fit:cover;">`;
                } else if (conf.lbar_content_type === 'URL') {
                    contentDiv.innerHTML = `<iframe src="${conf.lbar_content_data}" style="width:100%;height:100%;border:none;"></iframe>`;
                }
            } else {
                lBar.style.width = '0';
                setTimeout(() => lBar.style.display = 'none', 500);
            }
        }

        // --- NEWS HANDLING ---
        async function fetchNews() {
            try {
                const res = await fetch(API_BASE + '/news');
                newsItems = await res.json();
                console.log(`Loaded ${newsItems.length} news items.`);
                updateTicker();
                if (!headlineInterval) startHeadlines();
            } catch (e) { console.error("News Fetch Error:", e); }
        }

        function updateTicker() {
            const active = newsItems.filter(i => i.is_active);
            const container = document.getElementById('tickerText');

            if (active.length === 0) {
                container.innerHTML = '<span class="ticker-item">No active news.</span>';
                return;
            }

            // Create loop string
            const html = active.map(i =>
                `<span class="ticker-item"><i class="fas fa-circle" style="font-size:8px; color:#b90909;"></i> ${i.title_tamil}</span>`
            ).join('');

            // Repeat for smooth infinite scroll
            container.innerHTML = html + html + html;
        }

        function startHeadlines() {
            if (headlineInterval) clearInterval(headlineInterval);
            rotateHeadline();
            headlineInterval = setInterval(rotateHeadline, 10000); // 10s Rotation
        }

        function rotateHeadline() {
            if (newsItems.length === 0) return;

            // Prefer BREAKING, otherwise use all active
            let pool = newsItems.filter(i => i.type === 'BREAKING');
            if (pool.length === 0) pool = newsItems.filter(i => i.is_active);
            if (pool.length === 0) return;

            headlineIndex = (headlineIndex + 1) % pool.length;
            const item = pool[headlineIndex];

            const el = document.getElementById('topHeadline');
            el.style.opacity = 0;

            setTimeout(() => {
                el.innerText = item.title_tamil;
                el.style.opacity = 1;

                // Optional: Update Location
                if (item.source_url && item.source_url.length < 15) {
                    document.getElementById('locationText').innerText = item.source_url;
                } else {
                    document.getElementById('locationText').innerText = "LATEST NEWS";
                }
            }, 500);
        }

        // --- WEBSOCKET ---
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("WS Connected");
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type.includes('NEWS')) fetchNews();
            if (msg.type === 'CONFIG_UPDATED') applyConfig(msg.payload);
        };

        // INIT
        fetchConfig();
        fetchNews();
        // Fallback Poll
        setInterval(fetchNews, 20000);
        setInterval(fetchConfig, 10000);

    </script>
</body>

</html>