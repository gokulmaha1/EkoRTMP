<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- RESET & VARIABLES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Palette */
            --header-bg: #b90909;
            /* Deep Red */
            --footer-bg: #ffffff;
            --text-black: #000000;
            --text-white: #ffffff;
            --accent-gold: #f1c40f;

            /* Dimensions */
            --header-height: 90px;
            --ticker-height: 70px;
        }

        body {
            background-color: #000;
            /* Chroma Key or Video BG */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            width: 1280px;
            height: 720px;
        }

        /* --- VOTING STYLES --- */
        .party-bar-container {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            backdrop-filter: blur(4px);
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 50;
        }

        .party-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50px;
            transition: all 0.5s ease;
        }

        .bar {
            width: 100%;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 4px 4px 0 0;
            transition: height 1s ease;
            min-height: 10px;
            position: relative;
        }

        /* Party Colors */
        .bar-DMK {
            background: linear-gradient(to top, #dd2c00, #ff5722);
        }

        .bar-ADMK {
            background: linear-gradient(to top, #2e7d32, #4caf50);
        }

        .bar-BJP {
            background: linear-gradient(to top, #ff6f00, #ffca28);
        }

        .bar-NTK {
            background: linear-gradient(to top, #d32f2f, #f44336);
        }

        .bar-TVK {
            background: linear-gradient(to top, #bf360c, #d84315);
        }

        .count-badge {
            font-family: 'Oswald', sans-serif;
            font-size: 1.2rem;
            color: white;
            text-shadow: 1px 1px 2px black;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .label-badge {
            margin-top: 8px;
            background: #fff;
            color: #000;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Popup */
        .vote-popup {
            position: fixed;
            top: 120px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(200%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 60;
        }

        .vote-popup.show {
            transform: translateX(0);
        }

        .vote-popup img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .vote-popup .popup-text {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .vote-popup .popup-sub {
            font-size: 0.7rem;
            color: #ccc;
        }


        /* --- MAIN LAYOUT (GRID) --- */
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
            position: relative;
        }

        /* --- HEADER SECTION --- */
        /* --- VISUAL POLISH (PREMIUM TV LOOK) --- */
        :root {
            /* Simplified Gradients for Performance */
            --header-gradient: #b90909;
            /* Solid color is faster */
            /* --gloss-overlay: linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.1) 100%); */
            /* --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.5); */
            /* Removed shadow */
        }

        /* --- HEADER SECTION --- */
        .top-header {
            grid-row: 1;
            background: var(--header-gradient);
            /* TABLE LAYOUT: Maximum Compatibility & Stability */
            display: table;
            width: 100%;
            table-layout: fixed;
            padding: 0 10px;
            border-bottom: 3px solid #ffcc00;
            /* Gold Accent Bottom */
            z-index: 100;
            /* box-shadow: var(--shadow-soft); */
            height: var(--header-height);
            position: relative;
        }

        /* Gloss Shine Effect (Pseudo-element for safety) 
        .top-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
            z-index: 0;
        }
        */

        /* Header Columns */
        .header-left {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: left;
            height: 100%;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .header-center {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            height: 100%;
            overflow: hidden;
            padding: 0 20px;
            position: relative;
            z-index: 2;
            width: 80%;
        }

        .header-right {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: right;
            height: 100%;
            position: relative;
            z-index: 2;
            padding-right: 15px;
        }

        /* Header Elements */
        .location-tag {
            background: #f0f0f0;
            /* Simplified gradient */
            color: #b90909;
            padding: 6px 15px;
            border-radius: 4px;
            /* Condensed Font */
            font-weight: 700;
            font-size: 20px;
            text-transform: uppercase;
            /* box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); */
            display: inline-flex;
            /* Fix flex alignment inside table cell */
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
        }

        .breaking-text {
            color: white !important;
            /* Better Tamil Font support */
            font-size: 32px;
            /* Large TV Size */
            font-weight: 700;
            white-space: nowrap;
            /* text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5); */
            /* Simplified Shadow */
            text-shadow: 1px 1px 0 #000;
            /* Ensure Visibility */
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            text-align: center;
            /* Center multi-line text */
            line-height: 1.2;
        }

        .logo-img {
            height: 94px;
            width: auto;
            object-fit: contain;
            /* filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4)); */
            display: inline-block !important;
        }

        /* --- MAIN CONTENT (Video + L-Bar) --- */
        .main-content {
            grid-row: 2;
            position: relative;
            background-color: transparent;
            display: flex;
            overflow: hidden;
        }

        .video-wrapper {
            flex-grow: 1;
            position: relative;
        }

        /* L-Bar (Side Panel) */
        .l-bar {
            width: 0;
            /* Hidden by default */
            background: #000;
            transition: width 0.5s ease;
            display: none;
        }

        /* Missing CSS for Vote Ticker */
        .vote-ticker-strip {
            position: absolute;
            bottom: 80px;
            /* Above footer */
            left: 0;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8), transparent);
            color: white;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 55;
            border-left: 4px solid #f1c40f;
        }

        .vt-label {
            font-weight: bold;
            font-size: 12px;
            color: #f1c40f;
            margin-right: 5px;
        }

        .vt-content {
            display: flex;
            gap: 10px;
        }

        .vt-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .vt-img {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- HEADER SECTION -->
        <div class="top-header">
            <div class="header-left">
                <div class="location-tag">
                    <i class="fas fa-map-marker-alt"></i> <span id="locationText">CHENNAI</span>
                </div>
            </div>
            <div class="header-center">
                <div id="topHeadline" class="breaking-text">WELCOME TO EKO TV NEWS</div>
            </div>
            <div class="header-right">
                <img src="/media/logo.gif" class="logo-img" onerror="this.style.display='none'">
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="video-wrapper">
                <!-- Background Players -->
                <video id="videoPlayer" style="display:none; width:100%; height:100%; object-fit:cover;" loop></video>
                <img id="imagePlayer" style="display:none; width:100%; height:100%; object-fit:cover;">
                <iframe id="webview" style="display:none; width:100%; height:100%; border:none;"></iframe>

                <!-- NEWS PRESENTATION (Split View) -->
                <div id="newsPresentation" class="news-presentation" style="display:none;">
                    <div class="np-media">
                        <img id="npImage" src="" style="display:none;">
                        <video id="npVideo" src="" style="display:none;" loop muted></video>
                        <div id="npPlaceholder" class="placeholder-icon" style="display:none;"><i
                                class="fas fa-newspaper"></i></div>
                    </div>
                    <div class="np-content">
                        <div id="npCategory" class="np-tag">NEWS</div>
                        <h1 id="npTitle" class="np-title">Loading...</h1>
                        <p id="npDescription" class="np-desc">Please wait for updates.</p>
                        <div id="npSource" class="np-meta">Source</div>
                    </div>
                </div>
            </div>
            <div class="l-bar"></div>
        </div>

        <!-- FOOTER SECTION -->
        <div class="bottom-footer">
            <div class="ticker-label">NEWS UPDATES</div>
            <div class="ticker-container">
                <marquee class="ticker-content" truespeed scrolldelay="30" scrollamount="2" id="tickerMarquee">
                    <span class="ticker-item">Loading news updates...</span>
                </marquee>
            </div>
            <div class="footer-right">
                <div style="display: flex; align-items: center; justify-content: space-between; height: 100%;">
                    <div class="live-badge">LIVE</div>
                    <div id="clockDisplay"
                        style="font-size: 24px; font-weight: 700; color: #333; font-family: 'Oswald', sans-serif;">00:00
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voting Overlay Containers -->
    <div id="voteOverlay" style="display: none;">
        <!-- 1. Bar Chart (Bottom Right) -->
        <div class="party-bar-container" id="voteBarContainer">
            <!-- Bars Injected Here -->
        </div>

        <!-- 2. Voter Ticker (Bottom Left) -->
        <div class="vote-ticker-strip">
            <div class="vt-label">LIVE VOTES</div>
            <div class="vt-content" id="voteTickerWrapper"></div>
        </div>

        <!-- 3. Popup (Top Right) -->
        <div class="vote-popup" id="votePopup">
            <img src="" id="vpImg" class="vp-img">
            <div>
                <div style="font-size: 10px; color: #ccc;">JUST VOTED</div>
                <div style="line-height: 1;">
                    <span id="vpName" style="font-weight: bold;">-</span>
                    <span style="font-size: 10px;">for</span>
                    <span id="vpParty" style="color: #f1c40f; font-weight: bold;">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        const API_BASE = '/api';

        // --- CLOCK ---
        function updateClock() {
            const now = new Date();
            let hrs = now.getHours();
            let min = now.getMinutes();
            const ampm = hrs >= 12 ? 'PM' : 'AM';
            hrs = hrs % 12;
            hrs = hrs ? hrs : 12;
            min = min < 10 ? '0' + min : min;

            document.getElementById('clockDisplay').innerText = `${hrs
                }
            :${min
                }
            ${ampm
                }

            `;
        }

        setInterval(updateClock, 1000);
        updateClock();

        // --- CONFIG & STATE ---
        let currentLayout = 'FULL';
        let newsItems = [];
        let headlineIndex = 0;
        let headlineInterval = null;

        // --- VOTING LOGIC ---
        let isVotingActive = false;
        let votePollInterval = null;
        let lastVoterId = null;

        async function checkVotingStatus() {
            try {
                const res = await fetch(`${API_BASE
                    }

                    /voting/status`);
                const data = await res.json();

                if (data.is_running && !isVotingActive) {
                    startVotingUI(data.video_id);
                }

                else if (!data.is_running && isVotingActive) {
                    stopVotingUI();
                }
            }

            catch (e) {
                console.error("Vote Status Error:", e);
            }
        }

        function startVotingUI(videoId) {
            console.log("Switching to Voting View");
            isVotingActive = true;

            // Hide News View
            document.getElementById('newsPresentation').style.display = 'none';
            // Stop News Rotation
            if (headlineInterval) clearInterval(headlineInterval);

            // Show Voting View
            document.getElementById('voteOverlay').style.display = 'block';

            // Start sub-pollers
            updateVoteStats();
            updateVoteTicker();

            votePollInterval = setInterval(() => {
                updateVoteStats();
                checkNewVoter();
                updateVoteTicker();
            }, 3000);
        }

        function stopVotingUI() {
            console.log("Switching to News View");
            isVotingActive = false;
            document.getElementById('voteOverlay').style.display = 'none';

            if (votePollInterval) clearInterval(votePollInterval);

            // Restore News View
            if (newsItems.length > 0) {
                document.getElementById('newsPresentation').style.display = 'flex';
                startHeadlines(); // Resume news
            }
        }

        async function updateVoteStats() {
            try {
                const res = await fetch(`${API_BASE
                    }

                    /voting/stats`);
                const data = await res.json();
                renderVoteBars(data.counts);
            }

            catch (e) { }
        }

        function renderVoteBars(counts) {
            const container = document.getElementById('voteBarContainer');
            if (!counts) return;

            const max = Math.max(...counts.map(c => c.count), 1);
            const fixedOrder = ['DMK',
                'ADMK',
                'TVK',
                'NTK',
                'BJP'];

            const html = fixedOrder.map(code => {
                const item = counts.find(c => c.party_code === code) || {
                    count: 0, party_tamil: code
                }

                    ;
                const h = Math.max((item.count / max) * 100, 5);

                // Color Map
                const colors = {
                    'DMK': 'linear-gradient(to top, #dd2c00, #ff5722)',
                    'ADMK': 'linear-gradient(to top, #2e7d32, #4caf50)',
                    'BJP': 'linear-gradient(to top, #ff6f00, #ffca28)',
                    'NTK': 'linear-gradient(to top, #d32f2f, #f44336)',
                    'TVK': 'linear-gradient(to top, #bf360c, #d84315)'
                }

                    ;

                return ` <div style="display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%; justify-content: flex-end;" > <div style="font-family: 'Oswald'; font-size: 24px; color: white; text-shadow: 1px 1px 2px black; font-weight: bold; margin-bottom: 5px;" >${item.count
                    }

                    </div> <div style="width: 100%; background: ${colors[code] || '#ccc'}; border-radius: 4px 4px 0 0; transition: height 1s ease; height: ${h}%;" ></div> <div style="margin-top: 8px; background: white; color: black; padding: 2px 5px; border-radius: 4px; font-weight: bold; font-size: 14px; width: 100%; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5);" >${item.party_tamil || code
                    }

                    </div> </div> `;
            }).join('');

            container.innerHTML = html;
        }

        async function updateVoteTicker() {
            try {
                const res = await fetch(`${API_BASE
                    }

                    /voting/ticker`);
                const voters = await res.json();
                const wrapper = document.getElementById('voteTickerWrapper');

                if (voters.length > 0) {
                    const html = voters.map(v => ` <div class="vt-item" > <img src="${v.profile_image_url}" class="vt-img" onerror="this.src='/media/logo.gif'" > <span style="font-weight: bold; color: #ffeb3b; margin-right: 5px;" >${v.display_name
                        }

                        </span> <span style="color: #ddd;" >voted</span> <span style="font-weight: bold; background: white; color: black; padding: 0 4px; border-radius: 2px; font-size: 12px; margin-left: 5px;" >${v.party_tamil || v.party_code
                        }

                        </span> </div> `).join('');
                    wrapper.innerHTML = html + html; // Duplicate for loop
                }
            }

            catch (e) { }
        }

        async function checkNewVoter() {
            try {
                const res = await fetch(`${API_BASE
                    }

                    /voting/latest`);
                const voter = await res.json();

                if (voter && voter.id && voter.id !== lastVoterId) {
                    lastVoterId = voter.id;
                    showVotePopup(voter);
                }
            }

            catch (e) { }
        }

        function showVotePopup(voter) {
            const popup = document.getElementById('votePopup');
            document.getElementById('vpImg').src = voter.profile_image_url;
            document.getElementById('vpName').innerText = voter.display_name;
            document.getElementById('vpParty').innerText = voter.party_tamil || voter.party_code;

            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 5000);
        }

        // Start Global Poll
        setInterval(checkVotingStatus, 5000);

        // ... (Existing Code) ...

        async function fetchConfig() {
            try {
                const res = await fetch(API_BASE + '/config'); // Fixed path
                const config = await res.json();
                // Apply Config logic...
                // Only if not voting? Or independent?
                // Let's allow config to set layout, but Voting overlays on top.
            }

            catch (e) {
                console.error("Config Error:", e);
            }
        }

        async function fetchNews() {
            try {
                // Fixed path: /api/news (server.py line 819)
                const res = await fetch(API_BASE + '/news');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                const data = await res.json();

                // Ensure it's an array
                if (Array.isArray(data)) {
                    newsItems = data;
                } else {
                    console.warn("API returned non-array for news:", data);
                    newsItems = [];
                }

                updateTicker(newsItems);
                if (newsItems.length > 0 && !headlineInterval) startHeadlines();
            }

            catch (e) {
                console.error("News Error:", e);
                newsItems = []; // Fallback
                updateTicker([]);
            }
        }

        function updateTicker(items) {
            const marquee = document.getElementById('tickerMarquee');
            // Filter Ticker items
            const tickers = items.filter(i => i.type === 'TICKER' || i.type === 'GENERAL');

            if (tickers.length === 0) {
                marquee.innerHTML = '<span class="ticker-item">No active news updates...</span>';
                return;
            }

            marquee.innerHTML = tickers.map(i => `<span class="ticker-item" ><i class="fas fa-newspaper text-red-600" ></i> ${i.title_tamil
                }

                </span>`).join('');
        }

        // --- ADVERTISEMENT LOGIC ---
        let activeAds = [];

        async function fetchAds() {
            try {
                const res = await fetch(API_BASE + '/api/ads/active');
                activeAds = await res.json();

                console.log(`Loaded ${activeAds.length
                    }

                    active ads.`);
            }

            catch (e) {
                console.error("Ad Fetch Error:", e);
            }
        }

        function getAdsByType(type) {
            return activeAds.filter(a => a.type === type);
        }

        // --- FULLSCREEN ADS & INTERRUPTIONS ---
        let adIntervalHandle = null;
        const AD_CHECK_INTERVAL = 60000; // Check every minute

        function startAdScheduler() {
            if (adIntervalHandle) clearInterval(adIntervalHandle);

            // Check less frequently to avoid constant interruption, but enough to catch schedule
            adIntervalHandle = setInterval(() => {
                const fsAds = getAdsByType('FULLSCREEN');

                if (fsAds.length > 0 && Math.random() > 0.5) {
                    // 50% chance to play if available, or use strict interval
                    // Pick one
                    const ad = fsAds[Math.floor(Math.random() * fsAds.length)];
                    playFullscreenAd(ad);
                }
            }

                , 5 * 60 * 1000); // 5 Minutes
        }

        function playFullscreenAd(ad) {
            console.log("Playing Ad:", ad);

            // 1. Stop News Rotation
            if (headlineInterval) clearInterval(headlineInterval);

            // 2. Show Ad
            updateMainScreen({
                webview_url: ad.content,
                type: 'AD'
            });

            // 3. Resume after Duration
            setTimeout(() => {
                // Determine what to do next?
                // Ideally, go back to News Loop
                startHeadlines();
            }

                , ad.duration * 1000);
        }

        // --- CORE LOOP ---
        function startHeadlines() {
            if (headlineInterval) clearInterval(headlineInterval);
            // Immediate trigger
            rotateHeadline();
            // Loop
            headlineInterval = setInterval(rotateHeadline, 15000); // 15s per item
        }

        function rotateHeadline() {
            // Priority:
            // 1. If Ad is playing, do nothing? (Handled by clearing interval)

            if (newsItems.length === 0) return;

            // Use ONLY active items WITH MEDIA for main screen loop (Text-only news will only appear in ticker)
            let pool = newsItems.filter(i => i.is_active && i.media_url && getMediaType(i.media_url) !== 'NONE');

            if (pool.length === 0) {
                // No image news available? Hide news presentation to show background stream
                document.getElementById('newsPresentation').style.display = 'none';
                return;
            }

            headlineIndex = (headlineIndex + 1) % pool.length;
            const item = pool[headlineIndex];

            // --- HEADER UPDATE ---
            const el = document.getElementById('topHeadline');
            el.classList.remove('animate-in');
            el.classList.add('animate-out');

            setTimeout(() => {
                const text = item.title_tamil || "";
                el.innerText = text;

                // Sizing text
                if (text.length > 50) {
                    el.style.fontSize = "22px";
                    el.style.whiteSpace = "normal";
                    el.style.lineHeight = "1.3";
                }

                else {
                    el.style.fontSize = "32px";
                    el.style.whiteSpace = "nowrap";
                    el.style.lineHeight = "1.2";
                }

                // Location - Always show static label
                document.getElementById('locationText').innerText = "à®…à®£à¯ à®®à¯ˆ à®šà¯†à®¯à¯ à®¤à®¿à®•à®³à¯ ";

                el.classList.remove('animate-out');
                el.classList.add('animate-in');
            }

                , 500);


            // --- MAIN SCREEN AUTOMATION ---
            // Logic:
            // 1. If item has media -> Show split layout
            // 2. If item has NO media -> Show default/webview OR keep previous?
            //    For now, let's behave like a TV channel. If no media, maybe show logo or just keep text?
            //    Current implementation: Only interrupts if media exists.
            //    FIX: If we want a continuous loop, we should explicitly "clear" or show something else if no media?

            const MAX_AGE_MS = 24 * 60 * 60 * 1000;
            const itemDate = new Date(item.created_at || new Date());
            const now = new Date();
            const isRecent = (now - itemDate) < MAX_AGE_MS;

            // --- MAIN SCREEN AUTOMATION ---
            // Logic: If media exists, show split view.
            // If NOT, show Text-Only mode (Full width content).

            const displayItem = {
                id: item.id,
                title: item.title_tamil,
                category: item.category,
                media_url: item.media_url,
                source: item.source,
                description: item.title_english || item.title_tamil
            }

                ;
            showNewsLayout(displayItem);

        }

        // --- TRANSITION LOGIC ---
        let isTransitioning = false;

        async function showNewsLayout(item) {
            // Check if already showing this item to avoid redundant anims?
            // Actually, for loop, we might want to re-show.

            const container = document.getElementById('newsPresentation');

            // If already visible, transition OUT first
            if (container.style.display === 'flex' && !isTransitioning) {
                isTransitioning = true;
                container.classList.add('page-exit');

                // Wait for animation
                await new Promise(r => setTimeout(r, 500));

                container.classList.remove('page-exit');
                // Reset scroll/state if needed
                isTransitioning = false;
            }

            // Populate Data
            const cat = document.getElementById('npCategory');
            const tit = document.getElementById('npTitle');
            const desc = document.getElementById('npDescription');
            const meta = document.getElementById('npSource');

            if (cat) cat.innerText = item.category || 'NEWS';
            if (tit) tit.innerText = item.title;
            if (desc) desc.innerText = item.description || item.title; // Fallback

            if (meta) meta.innerHTML = `<i class="fas fa-link"></i>${item.source
                }

            `;

            // --- RESET TEXT ANIMATIONS ---
            if (cat) cat.classList.remove('anim-tag-in');
            if (tit) tit.classList.remove('anim-title');
            if (desc) desc.classList.remove('anim-desc');
            if (meta) meta.classList.remove('anim-meta');

            if (tit) void tit.offsetWidth; // Reflow

            if (cat) cat.classList.add('anim-tag-in');
            if (tit) tit.classList.add('anim-title');
            if (desc) desc.classList.add('anim-desc');
            if (meta) meta.classList.add('anim-meta');

            // Handle Media
            const img = document.getElementById('npImage');
            const vid = document.getElementById('npVideo');
            const placeholder = document.getElementById('npPlaceholder');

            if (img) img.style.display = 'none';
            if (vid) vid.style.display = 'none';
            if (placeholder) placeholder.style.display = 'none';
            if (img) img.classList.remove('ken-burns-active'); // Reset Ken Burns

            // Reset Toggle Class
            container.classList.remove('no-media');

            if (item.media_url && getMediaType(item.media_url) !== 'NONE') {
                const type = getMediaType(item.media_url);

                if (type === 'VIDEO') {
                    vid.src = item.media_url;
                    vid.style.display = 'block';
                    vid.play().catch(e => console.error("News AutoPlay Error:", e));
                }

                else {
                    img.src = item.media_url;
                    img.style.display = 'block';

                    // Trigger Ken Burns Reflow
                    void img.offsetWidth;
                    img.classList.add('ken-burns-active');
                }
            }

            else {
                // NO MEDIA -> TEXT ONLY MODE
                container.classList.add('no-media');
            }

            // Show Container with ENTER animation
            container.style.display = 'flex';
            container.classList.remove('page-enter');
            void container.offsetWidth;
            container.classList.add('page-enter');

            // --- TRIGGER BACKEND TTS ---
            if (item.title) {
                fetch(API_BASE + '/tts', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        text: item.title, lang: 'ta'
                    })
                }).catch(err => console.error("TTS Auto-Trigger Failed:", err));
            }
        }

        // --- HELPER: Detect Media Type ---
        function getMediaType(url) {
            if (!url) return 'NONE';
            // Remove query params for extension check
            const cleanUrl = url.split('?')[0].toLowerCase();

            if (cleanUrl.match(/\.(mp4|webm|ogg|mov)$/)) return 'VIDEO';
            if (cleanUrl.match(/\.(jpeg|jpg|gif|png|webp|bmp|svg)$/)) return 'IMAGE';
            return 'WEB';
        }

        // --- WEBSOCKET ---
        // Basic Reconnection Logic
        function connectWebSocket() {
            const WS_URL = 'ws://' + window.location.host + '/ws/news';
            const ws = new WebSocket(WS_URL);
            ws.onopen = () => console.log("WS Connected");

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type && msg.type.includes('NEWS')) fetchNews();
                if (msg.type === 'CONFIG_UPDATED') applyConfig(msg.payload);
                // if (msg.type === 'OVERLAY_UPDATED') updateMainScreen(msg.payload);
                if (msg.type === 'SHOW_NEWS_MAIN') showNewsLayout(msg.payload);
            }

                ;
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
            ws.onerror = (e) => console.error("WS Error:", e);
        }

        connectWebSocket();


        // INIT
        fetchConfig();
        fetchNews();
        fetchAds();

        // Start Scheduler
        setTimeout(startAdScheduler, 5000); // Delay start

    </script>
</body>

</html>