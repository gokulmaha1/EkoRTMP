<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- RESET & VARIABLES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* Palette */
            --header-bg: #b90909;
            /* Deep Red */
            --footer-bg: #ffffff;
            --text-black: #000000;
            --text-white: #ffffff;
            --accent-gold: #f1c40f;

            /* Dimensions */
            --header-height: 90px;
            --ticker-height: 70px;
        }

        body {
            background-color: #000;
            /* Chroma Key or Video BG */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            width: 1280px;
            height: 720px;
        }

        /* --- MAIN LAYOUT (GRID) --- */
        .container {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
            position: relative;
        }

        /* --- HEADER SECTION --- */
        /* --- VISUAL POLISH (PREMIUM TV LOOK) --- */
        :root {
            /* Richer TV Gradient */
            --header-gradient: linear-gradient(to bottom, #cc0000 0%, #990000 100%);
            --gloss-overlay: linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.1) 100%);
            --shadow-soft: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* --- HEADER SECTION --- */
        .top-header {
            grid-row: 1;
            background: var(--header-gradient);
            /* TABLE LAYOUT: Maximum Compatibility & Stability */
            display: table;
            width: 100%;
            table-layout: fixed;
            padding: 0 10px;
            border-bottom: 3px solid #ffcc00;
            /* Gold Accent Bottom */
            z-index: 100;
            box-shadow: var(--shadow-soft);
            height: var(--header-height);
            position: relative;
        }

        /* Gloss Shine Effect (Pseudo-element for safety) */
        .top-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header Columns */
        .header-left {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: left;
            height: 100%;
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .header-center {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            height: 100%;
            overflow: hidden;
            padding: 0 20px;
            position: relative;
            z-index: 2;
            width: 80%;
        }

        .header-right {
            display: table-cell;
            width: 200px;
            vertical-align: middle;
            text-align: right;
            height: 100%;
            position: relative;
            z-index: 2;
            padding-right: 15px;
        }

        /* Header Elements */
        .location-tag {
            background: linear-gradient(to bottom, #ffffff 0%, #e0e0e0 100%);
            color: #b90909;
            padding: 6px 15px;
            border-radius: 4px;
            /* Condensed Font */
            font-weight: 700;
            font-size: 20px;
            text-transform: uppercase;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            display: inline-flex;
            /* Fix flex alignment inside table cell */
            align-items: center;
            gap: 8px;
            border: 1px solid #ccc;
        }

        .breaking-text {
            color: white !important;
            /* Better Tamil Font support */
            font-size: 32px;
            /* Large TV Size */
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
            /* Hard Shadow for crispness */
            /* Ensure Visibility */
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            text-align: center;
            /* Center multi-line text */
            line-height: 1.2;
        }

        .logo-img {
            height: 94px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.4));
            display: inline-block !important;
        }

        /* --- MAIN CONTENT (Video + L-Bar) --- */
        .main-content {
            grid-row: 2;
            position: relative;
            background-color: transparent;
            display: flex;
            overflow: hidden;
        }

        .video-wrapper {
            flex-grow: 1;
            position: relative;
        }

        /* L-Bar (Side Panel) */
        .l-bar {
            width: 0;
            /* Hidden by default */
            background: #000;
            transition: width 0.5s ease;
            display: none;
        }

        /* Media Elements */
        #videoPlayer,
        #imagePlayer,
        #webview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
            border: none;
        }

        /* --- FOOTER SECTION --- */
        .bottom-footer {
            grid-row: 3;
            background-color: var(--footer-bg);
            /* TABLE LAYOUT: For Stability */
            display: table;
            width: 100%;
            table-layout: fixed;
            border-top: 4px solid #cc0000;
            z-index: 100;
            height: var(--ticker-height);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
        }

        .ticker-label {
            display: table-cell;
            width: 180px;
            /* Fixed Width */
            vertical-align: middle;
            background: var(--header-gradient);
            /* Match Header */
            color: white;
            font-size: 22px;
            font-weight: 700;
            padding: 0 25px;
            height: 100%;
            z-index: 10;
            text-transform: uppercase;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
            /* Separation Shadow */
            position: relative;
        }

        /* Ticker Triangle Arrow */
        .ticker-label::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 0;
            bottom: 0;
            width: 10px;
            background: inherit;
            clip-path: polygon(0 0, 100% 50%, 0 100%);
            z-index: 12;
        }

        .ticker-container {
            display: table-cell;
            vertical-align: middle;
            background: white;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .ticker-content {
            display: block;
            width: 100%;
            padding-top: 5px;
            /* Center text vertically */
        }

        .ticker-item {
            font-size: 28px;
            font-weight: 600;
            color: #000;
            margin-right: 80px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .footer-right {
            display: table-cell;
            width: 240px;
            /* Slightly wider */
            vertical-align: middle;
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            height: 100%;
            border-left: 2px solid #ddd;
            padding: 0 15px;
            z-index: 20;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        }

        .live-badge {
            background: #d60000;
            color: white;
            font-weight: 700;
            padding: 7px 10px;
            border-radius: 25px;
            font-size: 14px;
            display: inline-flex !important;
            align-items: stretch;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            float: right;
            display: inline-block;
            /* margin-top: 4px; */
            flex-direction: row;

        }

        .datetime {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
        }

        .time-display {
            font-family: 'Oswald', sans-serif;
            font-size: 25px;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1;
            margin-bottom: 4px;
            margin-right: 3px;
        }

        .date-display {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Blink Animation */
        .blink-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
            float: left;
            margin-top: 9px;
            margin-left: 2px;
            margin-right: 5px;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        /* --- ANIMATIONS --- */
        @keyframes slideOutDown {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        @keyframes slideInDown {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-out {
            animation: slideOutDown 0.5s forwards;
        }

        .animate-in {
            animation: slideInDown 0.5s forwards;
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- ROW 1: HEADER -->
        <div class="top-header">
            <!-- Left: Location -->
            <div class="header-left">
                <div class="location-tag">
                    <!-- <i class="fas fa-map-marker-alt"></i> -->
                    <span id="locationText">அண்மை செய்திகள்</span>
                </div>
            </div>

            <!-- Center: Headline -->
            <div class="header-center">
                <div id="topHeadline" class="breaking-text">
                    தமிழ் செய்திகள் 24x7
                </div>
            </div>

            <!-- Right: Logo -->
            <div class="header-right">
                <!-- Direct Path with default fallback -->
                <img id="headerLogo" src="media/logo.gif" class="logo-img" alt="Logo">
            </div>
        </div>

        <!-- ROW 2: MAIN CONTENT -->
        <div class="main-content">
            <div class="video-wrapper">
                <iframe id="webview" src=""></iframe>
                <video id="videoPlayer" muted playsinline></video>
                <img id="imagePlayer" src="">
            </div>
            <!-- Optional L-Bar -->
            <div id="lBar" class="l-bar" style="display: none;">
                <div id="lBarContent" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <!-- ROW 3: FOOTER -->
        <div class="bottom-footer">
            <div class="ticker-label">NEWS UPDATES</div>

            <div class="ticker-container">
                <div class="ticker-container">
                    <!-- User requested Marquee for ticker -->
                    <marquee id="tickerText" class="ticker-content" scrollamount="12" scrolldelay="100">
                        <!-- JS will inject items here -->
                    </marquee>
                </div>
            </div>

            <div class="footer-right">
                <div class="live-badge">நேரலை <div class="blink-dot"></div>
                </div>
                <div class="datetime">
                    <div id="clock" class="time-display">12:00 PM</div>
                    <div id="dateDisplay" class="date-display">01/01/2026</div>
                </div>
                <!-- Optional Footer Logo
                <img src="/media/logo.gif" class="logo-img" style="height: 40px; margin-left: 5px;">
                -->
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
        const DEFAULT_LOGO = "/media/logo.gif";
        const API_BASE = window.location.origin + '/api';
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // STATE
        let newsItems = [];
        let headlineIndex = 0;
        let headlineInterval = null;

        // --- CLOCK ---
        function updateTime() {
            const now = new Date();
            // Force IST Timezone
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            });
            const dateStr = now.toLocaleDateString('en-GB', {
                timeZone: 'Asia/Kolkata'
            }); // DD/MM/YYYY

            document.getElementById('clock').innerText = timeStr;
            document.getElementById('dateDisplay').innerText = dateStr;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- LOG DATA & CONFIG ---
        async function fetchConfig() {
            try {
                const res = await fetch(API_BASE + '/config');
                const conf = await res.json();
                applyConfig(conf);
            } catch (e) {
                console.error("Config Fetch Error:", e);
                // Fallback already in HTML
            }
        }

        function applyConfig(conf) {
            const root = document.documentElement;

            // Colors
            if (conf.brand_color_primary) root.style.setProperty('--header-bg', conf.brand_color_primary);
            if (conf.brand_color_dark) document.body.style.backgroundColor = conf.brand_color_dark; // Debug bg

            // Logo
            const logoUrl = conf.logo_url || DEFAULT_LOGO;
            const logoEl = document.getElementById('headerLogo');
            if (logoEl) {
                logoEl.src = logoUrl;
                logoEl.style.display = 'block'; // Force show
            }

            // Text Labels
            if (conf.location_label) document.getElementById('locationText').innerText = conf.location_label;

            // L-Bar Logic
            const lBar = document.getElementById('lBar');
            const wrapper = document.querySelector('.main-content');

            if (conf.layout_mode === 'L_BAR') {
                const w = conf.lbar_width || 25;
                lBar.style.display = 'block';
                lBar.style.width = w + '%';
                lBar.style.backgroundColor = conf.lbar_bg_color || '#000';

                // Position
                wrapper.style.flexDirection = (conf.lbar_position === 'LEFT') ? 'row-reverse' : 'row';

                // Content
                const contentDiv = document.getElementById('lBarContent');
                if (conf.lbar_content_type === 'IMAGE' && conf.lbar_content_data) {
                    contentDiv.innerHTML = `<img src="${conf.lbar_content_data}" style="width:100%;height:100%;object-fit:cover;">`;
                } else if (conf.lbar_content_type === 'URL') {
                    contentDiv.innerHTML = `<iframe src="${conf.lbar_content_data}" style="width:100%;height:100%;border:none;"></iframe>`;
                }
            } else {
                lBar.style.width = '0';
                setTimeout(() => lBar.style.display = 'none', 500);
            }
        }

        // --- NEWS HANDLING ---
        async function fetchNews() {
            try {
                const res = await fetch(API_BASE + '/news');
                newsItems = await res.json();
                console.log(`Loaded ${newsItems.length} news items.`);
                updateTicker();
                if (!headlineInterval) startHeadlines();
            } catch (e) { console.error("News Fetch Error:", e); }
        }

        function updateTicker() {
            const active = newsItems.filter(i => i.is_active);
            const container = document.getElementById('tickerText');

            // Create loop string
            const html = active.map(i =>
                `<span class="ticker-item"><i class="fas fa-circle" style="font-size:15px; color:#b90909;"></i> ${i.title_tamil}</span>`
            ).join('');

            // Marquee loops automatically, no need to duplicate
            container.innerHTML = html;
        }

        function startHeadlines() {
            if (headlineInterval) clearInterval(headlineInterval);
            rotateHeadline();
            headlineInterval = setInterval(rotateHeadline, 10000); // 10s Rotation
        }

        function rotateHeadline() {
            if (newsItems.length === 0) return;

            // Prefer BREAKING, otherwise use all active
            let pool = newsItems.filter(i => i.type === 'BREAKING');
            if (pool.length === 0) pool = newsItems.filter(i => i.is_active);
            if (pool.length === 0) return;

            headlineIndex = (headlineIndex + 1) % pool.length;
            const item = pool[headlineIndex];

            const el = document.getElementById('topHeadline');

            // 1. Start Slide Out
            el.classList.remove('animate-in');
            el.classList.add('animate-out');

            setTimeout(() => {
                const text = item.title_tamil || "";
                el.innerText = text;

                // --- DYNAMIC SIZING LOGIC ---
                // Threshold for "Long Text" - approx 50 chars for Tamil
                if (text.length > 50) {
                    el.style.fontSize = "22px";
                    el.style.whiteSpace = "normal"; // Allow wrap
                    el.style.lineHeight = "1.3";
                } else {
                    el.style.fontSize = "32px";
                    el.style.whiteSpace = "nowrap"; // Single line
                    el.style.lineHeight = "1.2";
                }

                // Optional: Update Location
                if (item.source_url && item.source_url.length < 15) {
                    document.getElementById('locationText').innerText = item.source_url;
                } else {
                    document.getElementById('locationText').innerText = "அண்மை செய்திகள்";
                }

                // 2. Start Slide In (from top)
                el.classList.remove('animate-out');
                el.classList.add('animate-in');
            }, 500); // Wait for slide-out (0.5s)
        }

        // --- WEBSOCKET ---
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("WS Connected");
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type.includes('NEWS')) fetchNews();
            if (msg.type === 'CONFIG_UPDATED') applyConfig(msg.payload);
        };

        // INIT
        fetchConfig();
        fetchNews();
        // Fallback Poll
        setInterval(fetchNews, 20000);
        setInterval(fetchConfig, 10000);

    </script>
</body>

</html>