<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --brand-red: #c0392b;
            --brand-dark: #2c3e50;
            --brand-yellow: #f1c40f;
            --text-white: #ffffff;

            /* Layout Dimensions */
            --header-height: 80px;
            --ticker-height: 60px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            /* Black background for LED wall */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            /* Baloo for Tamil */
        }

        .container {
            width: 1280px;
            height: 720px;
            position: relative;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
        }

        /* --- ZONE 0: Main Video Area --- */
        .main-content-wrapper {
            grid-row: 2;
            grid-column: 1;
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        .video-area {
            flex-grow: 1;
            position: relative;
            background-color: #1a1a1a;
            overflow: hidden;
            transition: width 0.5s ease;
        }

        .l-bar-area {
            width: 0;
            /* Default 0 width (Hidden) */
            height: 100%;
            background-color: #000;
            overflow: hidden;
            transition: width 0.5s ease;
            position: relative;
        }

        iframe#webview,
        video#videoPlayer,
        img#imagePlayer {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
            /* OR cover, depending on preference */
            display: none;
            /* Hidden by default */
        }

        /* --- ZONE 1: Top Header --- */
        .top-header {
            grid-row: 1;
            grid-column: 1 / span 2;
            background: linear-gradient(90deg, var(--brand-red) 0%, #a90e0e 100%);
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
            padding: 0 20px;
        }

        .breaking-badge {
            background-color: white;
            color: var(--brand-red);
            padding: 5px 20px;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 28px;
            text-transform: uppercase;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            margin-right: 20px;
            animation: pulse-red 2s infinite;
        }

        .breaking-text {
            color: white;
            font-size: 32px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- ZONE 2: Bottom Ticker --- */
        .bottom-ticker {
            grid-row: 3;
            grid-column: 1 / span 2;
            background-color: white;
            /* White Background */
            display: flex;
            align-items: center;
            z-index: 20;
            border-top: 4px solid var(--brand-red);
            /* Red Border Top */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .ticker-label {
            background-color: var(--brand-red);
            /* Red Background */
            color: white;
            /* White Text */
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 20px;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            text-transform: uppercase;
        }

        .ticker-wrapper {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .ticker-content {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 25s linear infinite;
            font-size: 24px;
            font-weight: 700;
            /* Bolder */
            color: black;
            /* Black Text */
        }

        .ticker-item {
            margin-right: 100px;
            display: inline-flex;
            align-items: center;
        }

        .ticker-item i {
            margin-right: 10px;
            color: var(--brand-red);
        }

        .right-panel {
            display: flex;
            align-items: center;
            height: 100%;
            background-color: white;
            /* White Background */
            padding-right: 20px;
            white-space: nowrap;
            z-index: 30;
            border-left: 1px solid #eee;
        }

        .panel-widget {
            padding: 20px;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Branding */
        .brand-logo {
            margin-bottom: auto;
            padding-top: 20px;
        }

        .logo-img {
            height: 40px;
            /* Fit in 60px ticker */
            width: auto;
            display: block;
            margin: 0 15px;
        }

        .live-box {
            display: inline-block;
            background-color: var(--brand-red);
            color: white;
            padding: 2px 10px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            animation: blink 1.5s infinite;
        }

        .clock {
            font-family: 'Oswald', sans-serif;
            font-size: 24px;
            color: #333;
            /* Dark Grey Clock */
            font-weight: 700;
            margin-left: 10px;
        }

        /* Breaking Box in Right Panel */
        .breaking-side-list {
            flex-grow: 1;
            padding: 10px;
            overflow: hidden;
        }

        .side-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid var(--brand-red);
            font-size: 16px;
            animation: fadeIn 0.5s ease;
        }

        /* Animations */
        @keyframes ticker {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(192, 57, 43, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Header -->
        <div class="top-header">
            <div class="breaking-badge">BREAKING</div>
            <div class="breaking-text" id="topHeadline">
                Welcome to EKO Professional News System...
            </div>
        </div>

        <!-- Main Content Wrapper (Video + L-Bar) -->
        <div class="main-content-wrapper">

            <!-- Video Area -->
            <div class="video-area">
                <iframe id="webview" src=""></iframe>
                <video id="videoPlayer" muted autoplay
                    style="display:none; width:100%; height:100%; object-fit:contain;"></video>
                <img id="imagePlayer" src="" style="display:none; width:100%; height:100%; object-fit:contain;">
            </div>

            <!-- L-Bar Content Area -->
            <div class="l-bar-area" id="lBarArea">
                <div id="lBarContent" style="width:100%; height:100%;"></div>
            </div>

        </div>



        <!-- Ticker -->
        <div class="bottom-ticker">
            <div class="ticker-label">NEWS UPDATES</div>
            <div class="ticker-wrapper">
                <div class="ticker-content" id="tickerText">
                    <!-- Ticker items injected here -->
                </div>
            </div>
            <div class="right-panel">
                <div class="live-box">LIVE</div>
                <img src="/media/logo.gif" class="logo-img" alt="EKO TV">
                <div class="clock" id="clock">00:00</div>
            </div>
        </div>

    </div>

    <!-- Hidden Audio (Legacy support) -->
    <!-- Music is handled by backend GStreamer pipeline now -->

    <script>
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // Elements
        const elTopHeadline = document.getElementById('topHeadline');
        const elTickerText = document.getElementById('tickerText');
        const elWebview = document.getElementById('webview');
        const elVideo = document.getElementById('videoPlayer');
        const elImage = document.getElementById('imagePlayer');

        // State
        let newsItems = [];
        let currentMediaUrl = "";

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {
                timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Data Management
        async function fetchNews() {
            try {
                const res = await fetch('/api/news');
                newsItems = await res.json();
                updateUI();
            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        function updateUI() {
            // 1. Top Headline (Priority BREAKING)
            const breaking = newsItems.find(i => i.type === 'BREAKING');
            if (breaking) {
                elTopHeadline.innerText = breaking.title_tamil;
                elTopHeadline.parentElement.style.display = 'flex';
            } else {
                elTopHeadline.innerText = "";
            }

            // 2. Ticker (All TICKER types)
            const tickers = newsItems.filter(i => i.type === 'TICKER' || i.type === 'GENERAL');
            const tickerHtml = tickers.map(t =>
                `<span class="ticker-item"><i class="fas fa-circle" style="font-size:10px;"></i> ${t.title_tamil}</span>`
            ).join("");
            elTickerText.innerHTML = tickerHtml + tickerHtml;


        }

        function updateMedia(url) {
            if (url === currentMediaUrl) return;
            currentMediaUrl = url;

            // Reset all
            elWebview.style.display = 'none';
            elVideo.style.display = 'none';
            elImage.style.display = 'none';
            elVideo.pause();
            elWebview.src = 'about:blank'; // Unload iframe

            if (!url) return;

            // Detect Type
            const ext = url.split('.').pop().toLowerCase().split('?')[0];

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                // Video
                console.log("Attempting to play video:", url);
                elVideo.src = url;
                elVideo.style.display = 'block';
                elVideo.muted = true; // FORCE MUTED for Autoplay to work

                var playPromise = elVideo.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log("Video started playing successfully");
                        // Remove error msg if any
                        const err = document.getElementById('videoError');
                        if (err) err.remove();
                    })
                        .catch(error => {
                            console.error("Autoplay Error:", error);
                            showVideoError("Autoplay Blocked: " + error.message);
                        });
                }
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                // Image
                elImage.src = url;
                elImage.style.display = 'block';
            } else {
                // Iframe (YouTube, etc)
                elWebview.src = url;
                elWebview.style.display = 'block';
            }
        }

        function showVideoError(msg) {
            let err = document.getElementById('videoError');
            if (!err) {
                err = document.createElement('div');
                err.id = 'videoError';
                err.style.position = 'absolute';
                err.style.top = '50%';
                err.style.left = '50%';
                err.style.transform = 'translate(-50%, -50%)';
                err.style.color = 'red';
                err.style.background = 'rgba(0,0,0,0.8)';
                err.style.padding = '20px';
                err.style.zIndex = '100';
                err.innerText = msg;
                document.querySelector('.video-area').appendChild(err);
            } else {
                err.innerText = msg;
            }
        }

        // Connect WebSocket
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("Connected to News Feed");
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type.startsWith('NEWS')) {
                fetchNews();
            } else if (msg.type === 'CONFIG_UPDATED') {
                applyConfig(msg.payload);
            }
        };

        // Initial Load
        fetchNews();

        // FORCE FULL SCREEN RESET INITIALLY
        applyConfig({ layout_mode: 'FULL' });
        fetchConfig(); // Then fetch real config

        // TEST: Hardcoded Video (Big Buck Bunny)
        setTimeout(() => {
            updateMedia("http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4");
        }, 1500);

        // Re-enable Polling for Config/Media
        setInterval(async () => {
            try {
                // Only fetch if we aren't testing hardcoded video
                // For now, let's just log
                // const res = await fetch('/overlay/data');
            } catch (e) { }
        }, 3000);

        // --- Config Management ---
        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                const conf = await res.json();
                applyConfig(conf);
            } catch (e) { console.error(e); }
        }

        function applyConfig(conf) {
            const root = document.documentElement;
            if (conf.brand_color_primary) root.style.setProperty('--brand-red', conf.brand_color_primary);
            if (conf.brand_color_secondary) root.style.setProperty('--brand-yellow', conf.brand_color_secondary);
            if (conf.brand_color_dark) root.style.setProperty('--brand-dark', conf.brand_color_dark);

            if (conf.logo_url) {
                const img = document.querySelector('.logo-img');
                if (img) img.src = conf.logo_url;
            }

            if (conf.ticker_speed) {
                const content = document.querySelector('.ticker-content');
                if (content) content.style.animationDuration = conf.ticker_speed + 's';
            }

            // Text Labels
            if (conf.default_headline) {
                // Only update if not currently showing breaking news
                const headlines = newsItems.filter(i => i.type === 'BREAKING');
                if (headlines.length === 0) {
                    const el = document.getElementById('topHeadline');
                    if (el) el.innerText = conf.default_headline;
                }
            }

            if (conf.ticker_label) {
                const el = document.querySelector('.ticker-label');
                if (el) el.innerText = conf.ticker_label;
            }

            if (conf.breaking_label) {
                const el = document.querySelector('.breaking-badge');
                if (el) el.innerText = conf.breaking_label;
            }

            if (conf.live_label) {
                const el = document.querySelector('.live-box');
                if (el) el.innerText = conf.live_label;
            }

            // --- L-Bar Logic ---
            const lBar = document.getElementById('lBarArea');
            const lBarContent = document.getElementById('lBarContent');
            const wrapper = document.querySelector('.main-content-wrapper');

            if (conf.layout_mode === 'L_BAR') {
                const width = conf.lbar_width || 25; // Default 25%
                lBar.style.width = width + "%";

                // Position
                if (conf.lbar_position === 'LEFT') {
                    wrapper.style.flexDirection = 'row-reverse';
                } else {
                    wrapper.style.flexDirection = 'row';
                }

                // Background
                lBar.style.backgroundColor = conf.lbar_bg_color || '#000000';
                if (conf.lbar_bg_image) {
                    lBar.style.backgroundImage = `url('${conf.lbar_bg_image}')`;
                    lBar.style.backgroundSize = 'cover';
                    lBar.style.backgroundPosition = 'center';
                } else {
                    lBar.style.backgroundImage = 'none';
                }

                // Content
                const contentType = conf.lbar_content_type || 'IMAGE';
                const contentData = conf.lbar_content_data || '';

                if (contentType === 'IMAGE') {
                    lBarContent.innerHTML = `<img src="${contentData}" style="width:100%; height:100%; object-fit:contain;">`;
                } else if (contentType === 'URL') {
                    lBarContent.innerHTML = `<iframe src="${contentData}" style="width:100%; height:100%; border:none;"></iframe>`;
                } else if (contentType === 'HTML') {
                    lBarContent.innerHTML = contentData;
                } else {
                    lBarContent.innerHTML = "";
                }

            } else {
                // Full Screen
                lBar.style.width = "0";
                lBar.style.backgroundImage = 'none';
                lBarContent.innerHTML = ""; // Clear content to save resources
            }
        }

    </script>
    <!-- FontAwesome for Ticker icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>

</html>