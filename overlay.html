<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --brand-red: #c0392b;
            --brand-dark: #2c3e50;
            --brand-yellow: #f1c40f;
            --text-white: #ffffff;

            /* Layout Dimensions */
            --header-height: 80px;
            --ticker-height: 60px;
            --right-panel-width: 350px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            /* Black background for LED wall */
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
            /* Baloo for Tamil */
        }

        .container {
            width: 1280px;
            height: 720px;
            position: relative;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
            grid-template-columns: 1fr var(--right-panel-width);
        }

        /* --- ZONE 0: Main Video Area --- */
        .video-area {
            grid-row: 2;
            grid-column: 1;
            position: relative;
            background-color: #1a1a1a;
            overflow: hidden;
        }

        iframe#webview,
        video#videoPlayer,
        img#imagePlayer {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
            /* OR cover, depending on preference */
            display: none;
            /* Hidden by default */
        }

        /* --- ZONE 1: Top Header --- */
        .top-header {
            grid-row: 1;
            grid-column: 1 / span 2;
            background: linear-gradient(90deg, var(--brand-red) 0%, #a90e0e 100%);
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 20;
            padding: 0 20px;
        }

        .breaking-badge {
            background-color: white;
            color: var(--brand-red);
            padding: 5px 20px;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 28px;
            text-transform: uppercase;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            margin-right: 20px;
            animation: pulse-red 2s infinite;
        }

        .breaking-text {
            color: white;
            font-size: 32px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- ZONE 2: Bottom Ticker --- */
        .bottom-ticker {
            grid-row: 3;
            grid-column: 1 / span 2;
            background-color: var(--brand-dark);
            display: flex;
            align-items: center;
            z-index: 20;
            border-top: 4px solid var(--brand-yellow);
        }

        .ticker-label {
            background-color: var(--brand-yellow);
            color: black;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 24px;
            padding: 0 30px;
            height: 100%;
            display: flex;
            align-items: center;
            text-transform: uppercase;
        }

        .ticker-wrapper {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }

        .ticker-content {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 25s linear infinite;
            font-size: 24px;
            font-weight: 500;
            color: white;
        }

        .ticker-item {
            margin-right: 100px;
            display: inline-flex;
            align-items: center;
        }

        .ticker-item i {
            margin-right: 10px;
            color: var(--brand-yellow);
        }

        /* --- ZONE 3: Right Panel (Context/Ads) --- */
        .right-panel {
            grid-row: 2;
            grid-column: 2;
            background: linear-gradient(180deg, #2c3e50 0%, #000000 100%);
            border-left: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .panel-widget {
            padding: 20px;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Branding */
        .brand-logo {
            margin-bottom: auto;
            /* Push to top */
            padding-top: 20px;
        }

        .logo-text {
            font-family: 'Oswald', sans-serif;
            font-size: 40px;
            font-weight: 700;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .live-box {
            display: inline-block;
            background-color: red;
            color: white;
            padding: 2px 10px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
            margin-bottom: 10px;
            animation: blink 1.5s infinite;
        }

        .clock {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
            color: var(--brand-yellow);
        }

        /* Breaking Box in Right Panel */
        .breaking-side-list {
            flex-grow: 1;
            padding: 10px;
            overflow: hidden;
        }

        .side-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-left: 3px solid red;
            font-size: 16px;
            animation: fadeIn 0.5s ease;
        }

        /* Animations */
        @keyframes ticker {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(192, 57, 43, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(192, 57, 43, 0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Header -->
        <div class="top-header">
            <div class="breaking-badge">BREAKING</div>
            <div class="breaking-text" id="topHeadline">
                Welcome to EKO Professional News System...
            </div>
        </div>

        <!-- Video Area -->
        <div class="video-area">
            <iframe id="webview" src=""></iframe>
            <video id="videoPlayer" muted autoplay
                style="display:none; width:100%; height:100%; object-fit:contain;"></video>
            <img id="imagePlayer" src="" style="display:none; width:100%; height:100%; object-fit:contain;">
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-widget brand-logo">
                <div class="live-box">LIVE</div>
                <div class="logo-text">EKO TV</div>
                <div class="clock" id="clock">00:00</div>
            </div>

            <div class="breaking-side-list" id="sidePanel">
                <!-- Side items injected here -->
            </div>
        </div>

        <!-- Ticker -->
        <div class="bottom-ticker">
            <div class="ticker-label">NEWS UPDATES</div>
            <div class="ticker-wrapper">
                <div class="ticker-content" id="tickerText">
                    <!-- Ticker items injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Hidden Audio (Legacy support) -->
    <!-- Music is handled by backend GStreamer pipeline now -->

    <script>
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // Elements
        const elTopHeadline = document.getElementById('topHeadline');
        const elTickerText = document.getElementById('tickerText');
        const elSidePanel = document.getElementById('sidePanel');
        const elWebview = document.getElementById('webview');
        const elVideo = document.getElementById('videoPlayer');
        const elImage = document.getElementById('imagePlayer');

        // State
        let newsItems = [];
        let currentMediaUrl = "";

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {
                timeZone: 'Asia/Kolkata', hour: '2-digit', minute: '2-digit'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Data Management
        async function fetchNews() {
            try {
                const res = await fetch('/api/news');
                newsItems = await res.json();
                updateUI();
            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        function updateUI() {
            // 1. Top Headline (Priority BREAKING)
            const breaking = newsItems.find(i => i.type === 'BREAKING');
            if (breaking) {
                elTopHeadline.innerText = breaking.title_tamil;
                elTopHeadline.parentElement.style.display = 'flex';
            } else {
                elTopHeadline.innerText = "";
            }

            // 2. Ticker (All TICKER types)
            const tickers = newsItems.filter(i => i.type === 'TICKER' || i.type === 'GENERAL');
            const tickerHtml = tickers.map(t =>
                `<span class="ticker-item"><i class="fas fa-circle" style="font-size:10px;"></i> ${t.title_tamil}</span>`
            ).join("");
            elTickerText.innerHTML = tickerHtml + tickerHtml;

            // 3. Side Panel (Latest 3 items usually, or FLASH)
            const sidebarItems = newsItems.slice(0, 4);
            elSidePanel.innerHTML = sidebarItems.map(i => `
                <div class="side-item">
                    <div style="font-size:10px; color:#f1c40f;">${i.category}</div>
                    ${i.title_tamil}
                </div>
            `).join("");
        }

        function updateMedia(url) {
            if (url === currentMediaUrl) return;
            currentMediaUrl = url;

            // Reset all
            elWebview.style.display = 'none';
            elVideo.style.display = 'none';
            elImage.style.display = 'none';
            elVideo.pause();
            elWebview.src = 'about:blank'; // Unload iframe

            if (!url) return;

            // Detect Type
            const ext = url.split('.').pop().toLowerCase().split('?')[0];

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                // Video
                elVideo.src = url;
                elVideo.style.display = 'block';
                elVideo.muted = false; // Try unmuted
                var playPromise = elVideo.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Autoplay prevented:", error);
                        elVideo.muted = true;
                        elVideo.play();
                    });
                }
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                // Image
                elImage.src = url;
                elImage.style.display = 'block';
            } else {
                // Iframe (YouTube, etc)
                elWebview.src = url;
                elWebview.style.display = 'block';
            }
        }

        // Connect WebSocket
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("Connected to News Feed");
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type.startsWith('NEWS')) {
                fetchNews();
            }
        };

        // Initial Load
        fetchNews();

        // Poll for Webview/Media URL
        setInterval(async () => {
            try {
                const res = await fetch('/overlay/data');
                const d = await res.json();
                if (d.webview_url !== undefined) {
                    updateMedia(d.webview_url);
                }
            } catch (e) { }
        }, 1000); // Faster polling for responsiveness

    </script>
    <!-- FontAwesome for Ticker icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>

</html>