<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EKO TV Overlay</title>
    <!-- Import Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Roboto:wght@400;500;700&family=Baloo+Thambi+2:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Palette: Tamil News Style */
            --header-bg-start: #b90909;
            /* Deep Red */
            --header-bg-mid: #e71d1d;
            /* Bright Red */
            --header-bg-end: #8a0606;
            /* Darker Red */

            --footer-bg: #ffffff;
            --text-black: #000000;
            --text-white: #ffffff;
            --accent-gold: #f1c40f;

            --header-height: 90px;
            --ticker-height: 70px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Roboto', 'Baloo Thambi 2', sans-serif;
        }

        .container {
            width: 1280px;
            height: 720px;
            position: relative;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--ticker-height);
        }

        /* --- HEADER --- */
        .top-header {
            grid-row: 1;
            grid-column: 1 / span 2;
            background: linear-gradient(90deg, var(--header-bg-start) 0%, var(--header-bg-mid) 50%, var(--header-bg-end) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding: 0 10px;
        }

        /* Glossy Shine Overlay */
        .header-shine {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.0) 100%);
            pointer-events: none;
        }

        .header-left {
            flex: 0 0 150px;
            display: flex;
            justify-content: center;
        }

        .location-tag {
            background: linear-gradient(to bottom, #fff 0%, #eee 100%);
            color: #b90909;
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid #ccc;
        }

        .header-center {
            flex: 1;
            text-align: center;
            overflow: hidden;
        }

        .breaking-text {
            color: white;
            font-size: 38px;
            /* Bigger font */
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 20px;
            letter-spacing: 0.5px;
        }

        .header-right {
            flex: 0 0 150px;
            display: flex;
            justify-content: flex-end;
            padding-right: 10px;
        }

        .breaking-badge {
            background: #fff;
            color: #d60000;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 20px;
            padding: 2px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .blink-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #d60000;
            animation: blink 1s infinite;
        }

        /* --- FOOTER --- */
        .bottom-ticker {
            grid-row: 3;
            grid-column: 1 / span 2;
            background-color: var(--footer-bg);
            display: flex;
            align-items: center;
            z-index: 20;
            border-top: 4px solid var(--header-bg-mid);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        }

        .ticker-label {
            background-color: var(--header-bg-mid);
            color: white;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 22px;
            padding: 0 25px;
            height: 100%;
            display: flex;
            align-items: center;
            text-transform: uppercase;
            box-shadow: 4px 0 5px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 5;
        }

        .ticker-wrapper {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            display: flex;
            align-items: center;
            background: #fff;
        }

        .ticker-content {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
            font-size: 28px;
            /* Massive Text */
            font-weight: 800;
            color: var(--text-black);
            line-height: var(--ticker-height);
        }

        .ticker-item {
            margin-right: 80px;
            display: inline-flex;
            align-items: center;
        }

        .ticker-item i {
            margin-right: 12px;
            color: var(--header-bg-mid);
            font-size: 12px;
        }

        .right-panel {
            display: flex;
            align-items: center;
            height: 100%;
            background-color: #f1f2f6;
            /* Very light grey */
            padding: 0 15px;
            border-left: 1px solid #ddd;
            gap: 15px;
            z-index: 10;
        }

        .live-badge {
            background: #d60000;
            color: white;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            font-size: 16px;
            padding: 4px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .blink-dot-white {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
            animation: blink 1s infinite;
        }

        .datetime-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            line-height: 1.1;
        }

        .time-text {
            font-family: 'Oswald', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: #2c3e50;
        }

        .date-text {
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            font-weight: 500;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        /* --- CONTENT WRAPPER --- */
        .main-content-wrapper {
            grid-row: 2;
            grid-column: 1;
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }

        .video-area {
            flex-grow: 1;
            position: relative;
            background-color: #1a1a1a;
            overflow: hidden;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .l-bar-area {
            width: 0;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            display: none;
            transition: width 0.5s ease;
            position: relative;
        }

        iframe#webview,
        video#videoPlayer,
        img#imagePlayer {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
            display: none;
        }

        /* Animations */
        @keyframes ticker {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <!-- Header -->
        <div class="top-header">
            <div class="header-shine"></div> <!-- Glossy Effect -->

            <div class="header-left">
                <div class="location-tag">
                    <span class="loc-icon"><i class="fas fa-map-marker-alt"></i></span>
                    <span id="locationText">CHENNAI</span>
                </div>
            </div>

            <div class="header-center">
                <div class="breaking-text" id="topHeadline">
                    Welcome to EKO Professional News System...
                </div>
            </div>

            <div class="header-right">
                <img src="./media/logo.gif" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
        </div>

        <!-- Main Content Wrapper (Video + L-Bar) -->
        <div class="main-content-wrapper">
            <!-- Video Area -->
            <div class="video-area">
                <iframe id="webview" src=""></iframe>
                <video id="videoPlayer" muted playsinline
                    style="display:none; width:100%; height:100%; object-fit:contain;"></video>
                <img id="imagePlayer" src="" style="display:none; width:100%; height:100%; object-fit:contain;">
            </div>

            <!-- L-Bar Content Area -->
            <div class="l-bar-area" id="lBarArea">
                <div id="lBarContent" style="width:100%; height:100%;"></div>
            </div>
        </div>

        <!-- Ticker -->
        <div class="bottom-ticker">
            <div class="ticker-label">NEWS UPDATES</div>
            <div class="ticker-wrapper">
                <div class="ticker-content" id="tickerText">
                    <!-- Ticker items injected here -->
                </div>
            </div>
            <div class="right-panel">
                <div class="live-badge">
                    LIVE <span class="blink-dot-white"></span>
                </div>
                <div class="datetime-box">
                    <div class="date-text" id="dateDisplay">01/01/2026</div>
                    <div class="time-text" id="clock">12:00 PM</div>
                </div>
                <!-- Optional: Enable logo if needed, currently using clean look -->
                <!-- <img src="/media/logo.gif" class="logo-img" alt="EKO TV"> -->
            </div>
        </div>

    </div>

    <!-- Hidden Audio (Legacy support) -->
    <!-- Music is handled by backend GStreamer pipeline now -->

    <script>
        const WS_URL = 'ws://' + window.location.host + '/ws/news';

        // Elements
        const elTopHeadline = document.getElementById('topHeadline');
        const elTickerText = document.getElementById('tickerText');
        const elWebview = document.getElementById('webview');
        const elVideo = document.getElementById('videoPlayer');
        const elImage = document.getElementById('imagePlayer');

        // State
        let newsItems = [];
        let currentMediaUrl = "";
        let headlineIndex = 0;
        let headlineInterval = null;

        // Clock & Date
        function updateClock() {
            const now = new Date();

            // Time (e.g., 12:45 PM)
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-US', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            // Date (e.g., 25/12/2026) -> user asked for DD/MM/YY ??
            // Let's do standard DD/MM/YYYY for clarity or DD/MM/YY
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();

            const dateStr = `${day}/${month}/${year}`;
            document.getElementById('dateDisplay').innerText = dateStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Headline Rotator (Streams RSS/News one by one in Header)
        function startHeadlineRotation() {
            if (headlineInterval) clearInterval(headlineInterval);
            headlineRotation(); // Run immediately
            headlineInterval = setInterval(headlineRotation, 10000); // Change every 10s
        }

        function headlineRotation() {
            if (!newsItems || newsItems.length === 0) return;

            // Priority: Show BREAKING items first, then rotate all others
            const breaking = newsItems.filter(i => i.type === 'BREAKING');
            let candidates = [];

            if (breaking.length > 0) {
                // If there are breaking news, only cycle them
                candidates = breaking;
            } else {
                // Otherwise cycle everything (TICKER, GENERAL, etc)
                // Filter out items that are strictly for Ticker if needed, but user said "same content"
                candidates = newsItems.filter(i => i.is_active);
            }

            if (candidates.length === 0) return;

            // Wrap index
            headlineIndex = (headlineIndex + 1) % candidates.length;
            const item = candidates[headlineIndex];

            // Update UI with Fade
            elTopHeadline.style.opacity = '0';
            setTimeout(() => {
                elTopHeadline.innerText = item.title_tamil;
                // Optional: Update Location tag if item has it
                if (item.source_url) {
                    // Update location/source tag logic here if wanted
                    // document.getElementById('locationText').innerText = item.source_url;
                }
            }, 500);
        }

        // Data Management
        async function fetchNews() {
            try {
                const res = await fetch('/api/news');
                const data = await res.json();

                newsItems = data;
                console.log(`[Overlay] Fetched ${newsItems.length} news items.`);

                updateUI();

                if (!headlineInterval) startHeadlineRotation();

            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        // Poll News every 15 seconds (Fallback for WebSocket)
        setInterval(fetchNews, 15000);

        function updateUI() {
            // Ticker (All Active Items)
            // User said: "same content can be used in live ticker also"
            const activeItems = newsItems.filter(i => i.is_active);
            if (activeItems.length > 0) {
                const tickerHtml = activeItems.map(t =>
                    `<span class="ticker-item"><i class="fas fa-circle" style="font-size:10px;"></i> ${t.title_tamil}</span>`
                ).join("");
                elTickerText.innerHTML = tickerHtml + tickerHtml; // Duplicate for smooth loop
            }
        }

        function updateMedia(url) {
            if (url === currentMediaUrl) return;
            currentMediaUrl = url;

            // Reset all
            elWebview.style.display = 'none';
            elVideo.style.display = 'none';
            elImage.style.display = 'none';
            elVideo.pause();
            elWebview.src = 'about:blank'; // Unload iframe

            if (!url) return;

            // Detect Type
            const ext = url.split('.').pop().toLowerCase().split('?')[0];

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                // Video
                console.log("Attempting to play video:", url);
                elVideo.src = url;
                elVideo.style.display = 'block';
                elVideo.muted = true; // FORCE MUTED for Autoplay to work

                var playPromise = elVideo.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log("Video started playing successfully");
                        // Remove error msg if any
                        const err = document.getElementById('videoError');
                        if (err) err.remove();
                    })
                        .catch(error => {
                            console.error("Autoplay Error:", error);
                            showVideoError("Autoplay Blocked: " + error.message);
                        });
                }
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
                // Image
                elImage.src = url;
                elImage.style.display = 'block';
            } else {
                // Iframe (YouTube, etc)
                elWebview.src = url;
                elWebview.style.display = 'block';
            }
        }

        function showVideoError(msg) {
            let err = document.getElementById('videoError');
            if (!err) {
                err = document.createElement('div');
                err.id = 'videoError';
                err.style.position = 'absolute';
                err.style.top = '50%';
                err.style.left = '50%';
                err.style.transform = 'translate(-50%, -50%)';
                err.style.color = 'red';
                err.style.background = 'rgba(0,0,0,0.8)';
                err.style.padding = '20px';
                err.style.zIndex = '100';
                err.innerText = msg;
                document.querySelector('.video-area').appendChild(err);
            } else {
                err.innerText = msg;
            }
        }

        // Connect WebSocket
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => console.log("Connected to News Feed");
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type.startsWith('NEWS')) {
                fetchNews();
            } else if (msg.type === 'CONFIG_UPDATED') {
                applyConfig(msg.payload);
            }
        };

        // Initial Load
        fetchNews();

        // Load Config (will trigger ApplyConfig -> Layout Fix)
        fetchConfig();

        // TEST: Hardcoded Video (HTTPS) - RESTORED
        const TEST_VIDEO = "https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";
        setTimeout(() => {
            updateMedia(TEST_VIDEO);
        }, 1500);

        // Re-enable Polling
        setInterval(async () => {
            try {
                // Uncomment to enable real polling again
                // const res = await fetch('/overlay/data');
                // const d = await res.json();
                // if (d.webview_url !== undefined) updateMedia(d.webview_url);
            } catch (e) { }
        }, 3000);

        // --- Config Management ---
        async function fetchConfig() {
            try {
                const res = await fetch('/api/config');
                const conf = await res.json();
                applyConfig(conf);
            } catch (e) { console.error(e); }
        }

        function applyConfig(conf) {
            const root = document.documentElement;
            if (conf.brand_color_primary) root.style.setProperty('--brand-red', conf.brand_color_primary);
            if (conf.brand_color_secondary) root.style.setProperty('--brand-yellow', conf.brand_color_secondary);
            if (conf.brand_color_dark) root.style.setProperty('--brand-dark', conf.brand_color_dark);

            if (conf.logo_url) {
                const img = document.querySelector('.logo-img');
                if (img) img.src = conf.logo_url;
            }

            if (conf.ticker_speed) {
                const content = document.querySelector('.ticker-content');
                if (content) content.style.animationDuration = conf.ticker_speed + 's';
            }

            // Text Labels
            if (conf.default_headline) {
                // Only update if not currently showing breaking news
                const headlines = newsItems.filter(i => i.type === 'BREAKING');
                if (headlines.length === 0) {
                    const el = document.getElementById('topHeadline');
                    if (el) el.innerText = conf.default_headline;
                }
            }

            if (conf.ticker_label) {
                const el = document.querySelector('.ticker-label');
                if (el) el.innerText = conf.ticker_label;
            }

            if (conf.breaking_label) {
                const el = document.querySelector('.breaking-badge');
                if (el) el.innerText = conf.breaking_label;
            }

            if (conf.live_label) {
                const el = document.querySelector('.live-box');
                if (el) el.innerText = conf.live_label;
            }

            // --- L-Bar Logic ---
            const lBar = document.getElementById('lBarArea');
            const lBarContent = document.getElementById('lBarContent');
            const wrapper = document.querySelector('.main-content-wrapper');

            if (conf.layout_mode === 'L_BAR') {
                const width = conf.lbar_width || 25; // Default 25%
                lBar.style.display = 'block'; // SHOW
                // Slight delay to allow display:block to render before animating width
                setTimeout(() => lBar.style.width = width + "%", 10);

                // Position
                if (conf.lbar_position === 'LEFT') {
                    wrapper.style.flexDirection = 'row-reverse';
                } else {
                    wrapper.style.flexDirection = 'row';
                }

                // Background
                lBar.style.backgroundColor = conf.lbar_bg_color || '#000000';
                if (conf.lbar_bg_image) {
                    lBar.style.backgroundImage = `url('${conf.lbar_bg_image}')`;
                    lBar.style.backgroundSize = 'cover';
                    lBar.style.backgroundPosition = 'center';
                } else {
                    lBar.style.backgroundImage = 'none';
                }

                // Content
                const contentType = conf.lbar_content_type || 'IMAGE';
                const contentData = conf.lbar_content_data || '';

                if (contentType === 'IMAGE') {
                    lBarContent.innerHTML = `<img src="${contentData}" style="width:100%; height:100%; object-fit:contain;">`;
                } else if (contentType === 'URL') {
                    lBarContent.innerHTML = `<iframe src="${contentData}" style="width:100%; height:100%; border:none;"></iframe>`;
                } else if (contentType === 'HTML') {
                    lBarContent.innerHTML = contentData;
                } else {
                    lBarContent.innerHTML = "";
                }

            } else {
                // Full Screen
                lBar.style.width = "0";
                lBar.style.backgroundImage = 'none';
                setTimeout(() => lBar.style.display = 'none', 500); // Hide after transition
                lBarContent.innerHTML = ""; // Clear content to save resources
            }
        }

    </script>
    <!-- FontAwesome for Ticker icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>

</html>