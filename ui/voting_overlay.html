<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKO Vote Overlay</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Mukta+Malar:wght@400;700&family=Oswald:wght@500;700&display=swap');

        body {
            background-color: transparent;
            font-family: 'Mukta Malar', sans-serif;
            overflow: hidden;
        }

        .party-bar-container {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            backdrop-filter: blur(4px);
        }

        .party-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            transition: all 0.5s ease;
        }

        .bar {
            width: 100%;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 4px 4px 0 0;
            transition: height 1s ease;
            min-height: 10px;
            position: relative;
        }

        /* Party Colors */
        .bar-DMK {
            background: linear-gradient(to top, #dd2c00, #ff5722);
        }

        /* Red/Orange */
        .bar-ADMK {
            background: linear-gradient(to top, #2e7d32, #4caf50);
        }

        /* Green */
        .bar-BJP {
            background: linear-gradient(to top, #ff6f00, #ffca28);
        }

        /* Saffron */
        .bar-NTK {
            background: linear-gradient(to top, #d32f2f, #f44336);
        }

        /* Red */
        .bar-TVK {
            background: linear-gradient(to top, #bf360c, #d84315);
        }

        /* Deep Orange */

        .count-badge {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 2px black;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .label-badge {
            margin-top: 8px;
            background: #fff;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            width: 100%;
        }

        /* Ticker */
        .vote-ticker {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 50px;
            background: linear-gradient(90deg, #1e3a8a, #1e40af);
            border-radius: 8px;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .ticker-label {
            background: #ef4444;
            color: white;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            z-index: 10;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
        }

        .ticker-content {
            white-space: nowrap;
            padding-left: 100%;
            /* Start off-screen */
            animation: ticker 20s linear infinite;
            display: flex;
            align-items: center;
        }

        .voter-item {
            display: inline-flex;
            align-items: center;
            margin-right: 30px;
            color: white;
            font-size: 1rem;
        }

        .voter-img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
        }

        @keyframes ticker {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Popup */
        .vote-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(200%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .vote-popup.show {
            transform: translateX(0);
        }

        .party-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <!-- Main Container -->
    <div class="fixed bottom-24 right-5 w-96">
        <div class="party-bar-container" id="barContainer">
            <!-- Bars injected by JS -->
            <div class="text-white text-center w-full">Loading Votes...</div>
        </div>
        <div class="text-right text-[10px] text-white/50 mt-1 mr-1 font-sans">
            Public opinion via YouTube Chat
        </div>
    </div>

    <!-- Ticker -->
    <div class="vote-ticker">
        <div class="ticker-label">
            LIVE VOTING
        </div>
        <div class="ticker-content" id="tickerWrapper">
            <!-- Ticker Items -->
        </div>
    </div>

    <!-- Popup -->
    <div class="vote-popup" id="votePopup">
        <img src="" id="popupImg" class="w-8 h-8 rounded-full border border-white">
        <div>
            <div class="text-xs text-gray-400">JUST VOTED</div>
            <div class="font-bold leading-none"><span id="popupName">Name</span> <span
                    class="text-xs text-gray-300">for</span> <span id="popupParty" class="text-yellow-400">PARTY</span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/voting';
        let lastVoterId = null;

        // --- Logic ---

        async function updateStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                renderBars(data.counts);
                if (data.total) {
                    // Update total if needed
                }
            } catch (e) { console.error(e); }
        }

        async function updateTicker() {
            try {
                const res = await fetch(`${API_BASE}/ticker`);
                const voters = await res.json();

                const wrapper = document.getElementById('tickerWrapper');
                // Simple: Just rebuild content string, animation handles checks. 
                // Ideally we append, but for simplicity refresh.
                // To keep smoothness, maybe only update if changed drastically? 
                // Or just rely on CSS animation to cycle through a long list.

                if (voters.length > 0) {
                    const html = voters.map(v => `
                        <div class="voter-item">
                            <img src="${v.profile_image_url}" class="voter-img" onerror="this.src='/media/logo.gif'">
                            <span class="font-bold text-yellow-300 mr-1">${v.display_name}</span>
                            <span class="text-gray-200">voted</span>
                            <span class="ml-1 font-bold bg-white text-black px-1 rounded text-xs">${v.party_tamil || v.party_code}</span>
                        </div>
                    `).join('');

                    // Only update if content length differs significantly to avoid jump?
                    // CSS Ticker is tricky with dynamic content updates. 
                    // Hack: Duplicate content to ensure loop.
                    wrapper.innerHTML = html + html;
                }
            } catch (e) { console.error(e); }
        }

        async function checkPopup() {
            try {
                const res = await fetch(`${API_BASE}/latest`);
                const voter = await res.json();

                if (voter && voter.id !== lastVoterId) {
                    lastVoterId = voter.id;
                    showPopup(voter);
                }
            } catch (e) { console.error(e); }
        }

        // --- Rendering ---

        function renderBars(counts) {
            const container = document.getElementById('barContainer');
            if (!counts || counts.length === 0) return; // Keep "Loading" if empty?

            // Normalizing for height (Max value)
            const max = Math.max(...counts.map(c => c.count), 1); // Avoid div by zero

            // Sort by count desc or fixed party order? Fixed order is better for UI stability.
            const fixedOrder = ['DMK', 'ADMK', 'TVK', 'NTK', 'BJP'];

            // Map counts to order
            const mapped = fixedOrder.map(code => {
                const found = counts.find(c => c.party_code === code) || { count: 0, party_tamil: code };
                return { ...found, code };
            });

            container.innerHTML = mapped.map(item => {
                const heightPct = (item.count / max) * 100; // 0-100% of Max Height
                // Clamp min height to show label
                const h = Math.max(heightPct, 5);

                return `
                    <div class="party-col">
                        <div class="count-badge">${item.count}</div>
                        <div class="bar bar-${item.code}" style="height: ${h}%"></div>
                        <div class="label-badge text-[10px] md:text-sm whitespace-nowrap overflow-hidden text-ellipsis">${item.party_tamil || item.code}</div>
                    </div>
                `;
            }).join('');
        }

        function showPopup(voter) {
            const popup = document.getElementById('votePopup');
            const img = document.getElementById('popupImg');
            const name = document.getElementById('popupName');
            const party = document.getElementById('popupParty');

            img.src = voter.profile_image_url;
            name.innerText = voter.display_name;
            party.innerText = voter.party_tamil || voter.party_code;

            popup.classList.add('show');

            // Hide after 5s
            setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        // --- Init ---
        // updateStats();
        // updateTicker();

        setInterval(updateStats, 2000); // Fast updates for bars
        setInterval(checkPopup, 3000); // Check for new votes
        setInterval(updateTicker, 10000); // Refresh ticker list occassionally

    </script>
</body>

</html>